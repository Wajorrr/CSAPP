## Lab5-Cache Lab

### Part A: Writing a Cache Simulator

In Part A you will write a cache simulator in `csim.c` that takes a valgrind memory trace as input, simulates the hit/miss behavior of a cache memory on this trace, and outputs the total number of hits, misses, and evictions.

![](./assets/5.%20lab5-Cache%20Lab/2023-08-14-15-48-08.png)
![](./assets/5.%20lab5-Cache%20Lab/2023-08-14-15-48-55.png)

è¿™ä¸€éƒ¨åˆ†å°±æ˜¯è¦åœ¨`csim.c`ä¸­å†™ä¸€ä¸ªç¼“å­˜æ¨¡æ‹Ÿå™¨ï¼Œè¦æ±‚å¯¹äºæŒ‡å®šçš„traceï¼Œè¾“å‡ºä¸ç»™å®šçš„ç¼“å­˜æ¨¡æ‹Ÿå™¨å¯æ‰§è¡Œæ–‡ä»¶ä¸€æ ·çš„ä¿¡æ¯

å¯é€‰å‚æ•°çš„ä»‹ç»ä¸­æåˆ°äº†å‡ ä¸ªæ¦‚å¿µï¼Œå¹¶æ ‡æ˜äº†åœ¨ä¹¦ä¸Šæœ‰ç›¸å…³ä»‹ç»ï¼Œå…ˆçœ‹çœ‹

* `-s <s>`ï¼šNumber of set index bits ($S = 2^s$is the number of sets)
* `-E <E>`ï¼šAssociativity (number of lines per set)
* `-b <b>`ï¼šNumber of block bits ($B = 2^b$ is the block size)

![](./assets/5.%20lab5-Cache%20Lab/2023-08-14-15-56-56.png)

`Usage: ./csim-ref [-hv] -s <s> -E <E> -b <b> -t <tracefile>`

è¿™é‡Œ-så‚æ•°æŒ‡å®šçš„å°±æ˜¯æ­¤ç¼“å­˜**å…·æœ‰$2^s$ä¸ªç¼“å­˜ç»„**ï¼Œ-Eå‚æ•°æŒ‡å®šçš„å°±æ˜¯**æ¯ä¸ªç¼“å­˜ç»„åŒ…å«Eä¸ªç¼“å­˜è¡Œ**ï¼Œ-bå‚æ•°æŒ‡å®šçš„å°±æ˜¯**æ¯ä¸ªç¼“å­˜è¡ŒåŒ…å«$2^b$ä¸ªå­—èŠ‚**

å†æ¥çœ‹çœ‹ç»™å®šçš„ä¾‹å­ä¸­ç”¨åˆ°çš„yi.traceæ–‡ä»¶ï¼š
```
 L 10,1
 M 20,1
 L 22,1
 S 18,1
 L 110,1
 L 210,1
 M 12,1
```
![](./assets/5.%20lab5-Cache%20Lab/2023-08-14-18-14-55.png)

æŒ‡å®šå‚æ•° -s 4 -E 1 -b 4 åï¼Œæ˜¯å¦‚ä½•å¯¹è¿™ä¸ªtraceå¾—åˆ°ç»™å®šçš„ç»“æœçš„å‘¢ï¼Ÿ

```
L 10,1 miss
M 20,1 miss hit
L 22,1 hit
S 18,1 hit
L 110,1 miss eviction
L 210,1 miss eviction
M 12,1 miss eviction hit
hits:4 misses:5 evictions:3
```

å¯ä»¥çœ‹åˆ°è¿™é‡ŒæŒ‡å®šçš„ç¼“å­˜è¯»å–æ–¹å¼**å¹¶éå®ç°ç¼“å­˜ç½®æ¢ç®—æ³•æ—¶å¸¸è§åˆ°çš„kvæŸ¥æ‰¾æ–¹å¼**ï¼Œè€Œæ˜¯**ç»™å®šä¸€ä¸ªä¸»å­˜åœ°å€ï¼Œç„¶åæŒ‡å®šä¸€ä¸ªsize**ï¼Œè¡¨ç¤º**ä»è¿™ä¸ªä¸»å­˜åœ°å€å¤„è¯»å–sizeå¤§å°çš„å†…å®¹**ï¼Œè¿™å°±éœ€è¦å»å†äº†è§£ä¸‹å¦‚ä½•å°†è¿™æ ·çš„è·å–æŒ‡ä»¤è½¬åŒ–ä¸ºå¯¹ç¼“å­˜çš„è¯»å–äº†ï¼Œå†å»ä¹¦ä¸Šæ‰¾

![](./assets/5.%20lab5-Cache%20Lab/2023-08-14-17-48-03.png)

äºæ˜¯æˆ‘ä»¬å¯ä»¥æ¨¡æ‹Ÿä¸€ä¸‹ï¼Œ-s 4 -E 1 -b 4 ä»£è¡¨ç¼“å­˜å…·æœ‰16ä¸ªç¼“å­˜ç»„ï¼Œæ¯ä¸ªç¼“å­˜ç»„æœ‰1ä¸ªç¼“å­˜è¡Œï¼Œæ¯ä¸ªç¼“å­˜è¡Œæœ‰16ä¸ªå­—èŠ‚

å› æ­¤ä¸€ä¸ªä¸»å­˜åœ°å€ä¼šåŒ…å« t+4+4 ä½ï¼Œtä¸ºæ ‡è®°ä½é•¿åº¦

å½“æ‰§è¡ŒL load dataæ—¶ï¼Œç›¸å½“äºç›´æ¥æŸ¥æ‰¾ç¼“å­˜ï¼Œåé¦ˆç¼“å­˜æ˜¯å¦missï¼Œmissåˆ™å°†æ•°æ®è¯»å…¥ç¼“å­˜ï¼›æ‰§è¡ŒS storeæ—¶ï¼Œå’ŒæŸ¥æ‰¾ç¼“å­˜ä¸€æ ·ï¼Œéƒ½æ˜¯æ£€æŸ¥ç¼“å­˜ï¼Œåé¦ˆæ˜¯å¦missï¼Œmissåˆ™å°†æ•°æ®è¯»å…¥ç¼“å­˜ï¼›æ‰§è¡ŒM modifyæ—¶ï¼Œç›¸å½“äºå…ˆæŸ¥æ‰¾ï¼Œè‹¥å­˜åœ¨åˆ™ç›´æ¥ä¿®æ”¹ï¼Œå¦åˆ™åœ¨æ•°æ®è¯»å…¥ç¼“å­˜åå†ä¿®æ”¹ï¼›I è¡¨ç¤ºloadæŒ‡ä»¤ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¿½ç•¥æŒ‡ä»¤åŠ è½½å¼€é”€ï¼Œå› æ­¤å¿½ç•¥IæŒ‡ä»¤

æ¥ä¸‹æ¥é€æŒ‡ä»¤åˆ†æä¸€ä¸‹æ ·ä¾‹ç»“æœï¼š

1. L 10,1 miss
    * 0x10=0b0001 0000ï¼Œç»„ç´¢å¼•=1ï¼Œåç§»ä½=0ï¼Œsize=1ï¼Œ**miss**ï¼Œç¼“å­˜ç»„1çš„è¡Œç”Ÿæ•ˆï¼Œç¼“å­˜äº† 0b0001 0000~0b0001 1111=>`0x10~0x1f` çš„æ•°æ®
2. M 20,1 miss hit
    * 0x20=0b0010 0000ï¼Œç»„ç´¢å¼•=2ï¼Œåç§»ä½=0ï¼Œsize=1ï¼Œ**miss**ï¼Œç¼“å­˜ç»„2çš„è¡Œç”Ÿæ•ˆï¼Œç¼“å­˜äº† `0x20~0x2f` çš„æ•°æ®
    * ç”±äºæ“ä½œæ˜¯modifyï¼Œmissåè¯»å…¥ç¼“å­˜åï¼Œ**hit**
3. L 22,1 hit
    * 0x22=0b0010 0010ï¼Œç»„ç´¢å¼•=2ï¼Œåç§»ä½=2ï¼Œsize=1ï¼Œç¼“å­˜ç»„2çš„è¡Œå·²ç”Ÿæ•ˆï¼Œä¸”æ ‡è®°ä½ç›¸åŒï¼Œ**hit**
4. S 18,1 hit
    * 0x18=0b0001 1000ï¼Œç»„ç´¢å¼•=1ï¼Œåç§»ä½=8ï¼Œsize=1ï¼Œç¼“å­˜ç»„1çš„è¡Œå·²ç”Ÿæ•ˆï¼Œä¸”æ ‡è®°ä½ç›¸åŒï¼Œ**hit**
5. L 110,1 miss eviction
    * 0x110=0b1 0001 0000ï¼Œæ ‡è®°ä½=1ï¼Œç»„ç´¢å¼•=1ï¼Œåç§»ä½=0ï¼Œsize=1ï¼Œç¼“å­˜ç»„1çš„è¡Œå·²ç”Ÿæ•ˆï¼Œ**ä½†è¿™é‡Œæ ‡è®°ä½ä¸º1ï¼Œä¸ç¼“å­˜è¡Œçš„0ä¸åŒ**ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥çœ‹åˆ°å‰é¢åˆ†æçš„ç¼“å­˜è¡Œç¼“å­˜çš„æ˜¯`0x10~0x1f`ï¼Œå› æ­¤**missï¼Œéœ€è¦æ‰§è¡Œç¼“å­˜æ›¿æ¢**ï¼Œ**eviction**ï¼Œ**æ›¿æ¢åæ­¤æ—¶ç¼“å­˜è¡Œ1çš„æ ‡è®°ä½ä¸º1**ï¼Œç¼“å­˜çš„æ•°æ®ä¸º 0b1 0001 0000~0b1 0001 1111=>`0x110~0x11f`
6. L 210,1 miss eviction
    * 0x210=0b10 0001 0000ï¼Œæ ‡è®°ä½=2ï¼Œç»„ç´¢å¼•=1ï¼Œåç§»ä½=0ï¼Œå’Œä¸Šä¸€ä¸ªæŒ‡ä»¤çš„æƒ…å†µä¸€æ ·ï¼Œ**miss**ï¼Œç¼“å­˜ç»„1çš„è¡Œæ‰§è¡Œç¼“å­˜æ›¿æ¢ï¼Œ**eviction**ï¼Œæ›¿æ¢åæ ‡è®°ä½å˜ä¸º2ï¼Œç¼“å­˜çš„æ•°æ®ä¸º`0x210~0x21f`
7. M 12,1 miss eviction hit
    * 0x12=0b0001 0010ï¼Œæ ‡è®°ä½=0ï¼Œç»„ç´¢å¼•=1ï¼Œåç§»ä½=2ï¼Œç”±äºæ­¤æ—¶ç¼“å­˜ç»„1çš„è¡Œæ ‡è®°ä½=2ï¼Œå› æ­¤**miss**ï¼Œæ‰§è¡Œç¼“å­˜æ›¿æ¢ï¼Œ**eviction**ï¼Œæ›¿æ¢åæ ‡è®°ä½å˜ä¸º0ï¼Œç¼“å­˜çš„æ•°æ®ä¸º`0x10~0x1f`
    * ç”±äºæ˜¯modifyï¼Œç¼“å­˜æ›¿æ¢å**hit**

ç»“æœï¼šhits:4 misses:5 evictions:3

> æ„Ÿæ…¨ï¼šåœ¨æ­¤ä¹‹å‰è‡ªå·±æ›¾ç»çœ‹è¿‡ä¸€äº›ä»‹ç»ç»„ç›¸è”ã€çº§ç›¸è¿æ˜ å°„è¿™æ ·çš„çŸ¥è¯†çš„ä¸€äº›æ–‡ç« ï¼Œä½†æ˜¯ä¸€ç›´éƒ½ä¸æ˜¯çœŸæ­£çš„ç†è§£äº†ï¼Œç›´åˆ°ç°åœ¨åˆ†æäº†è¿™é‡Œçš„ä¾‹å­ï¼Œæ‰æ„Ÿè§‰è‡ªå·±å¥½åƒçœŸçš„æ‡‚è¿™ä¸ªä¸œè¥¿æ˜¯ä»€ä¹ˆäº†ï¼Œåªæƒ³è¯´ï¼Œæ¦‚å¿µæ€§çš„ä¸œè¥¿ç»ˆç©¶æ˜¯æ¦‚å¿µæ€§çš„ä¸œè¥¿ï¼Œä¸å›å½’åˆ°å®é™…æƒ…å†µè¿›è¡Œç†è§£ï¼ŒçœŸçš„å¯èƒ½å°±ä¸€ç›´éƒ½æ˜¯ä¸€çŸ¥åŠè§£ï¼Œæˆ–è€…é”™è¯¯ç†è§£ã€‚ã€‚ã€‚è¿™å°±åƒæ˜¯ä¸»è§‚ä¸å®¢è§‚ï¼Œæ¦‚å¿µéƒ½æ˜¯äººä¸»è§‚çš„æ€»ç»“ï¼Œæ¢ä¸ªäººå»çœ‹è¿™äº›æ¦‚å¿µçš„æ—¶å€™æ€»æ˜¯ä¼šå®¹æ˜“å› ä¸ºçŸ¥è¯†å‚¨å¤‡ä¸åŒï¼Œè€Œå‡ºç°ä¸€äº›ç†è§£åå·®ï¼Œå¯¼è‡´æ— æ³•ç†è§£æˆ–è€…é”™è¯¯ç†è§£ï¼›è€Œä»£ç ã€å®é™…çš„è¿è¡Œç»“æœè¿™äº›äº‹å®ï¼Œå°±æ˜¯å®¢è§‚çš„ä¸œè¥¿ï¼Œé’ˆå¯¹è¿™äº›ä¸œè¥¿è¿›è¡Œåˆ†æç†è§£ï¼Œæ°¸è¿œéƒ½æ˜¯æ›´åŠ ç²¾ç¡®çš„(å‰ææ˜¯å…·å¤‡æ­£ç¡®åˆ†ææŠ½è±¡çš„ç»“æœçš„èƒ½åŠ›ğŸ˜‚)

å¯ä»¥çœ‹å‡ºï¼Œè¿™ç§ç¼“å­˜æ–¹å¼å®é™…ä¸Šå°±æ˜¯**é’ˆå¯¹å†…å­˜åœ°å€è¿›è¡Œäº†ä¸€ä¸ªåˆ†ç»„**ï¼Œä¸åŒç¼“å­˜ç»„å¯¹ä¸åŒèŒƒå›´çš„å†…å­˜åœ°å€åˆ†åˆ«è¿›è¡Œç¼“å­˜ï¼Œ**ç»™å®šäº†å†…å­˜åœ°å€ï¼Œå…¶åªèƒ½è¢«å”¯ä¸€æŒ‡å®šå¥½çš„ä¸€ä¸ªç»„è¿›è¡Œç¼“å­˜**ï¼Œè€Œ**ç»„ä¸­å¯èƒ½ä¼šæœ‰å¤šä¸ªè¡Œï¼Œè¿™äº›è¡Œå°±åªç›¸å½“äºæ¯ä¸ªç»„çš„ç¼“å­˜ç©ºé—´ï¼Œå¹¶ä¸å¯¹åº”ç‰¹å®šå†…å­˜åœ°å€ç©ºé—´**ï¼Œæ¯ä¸ªè¡Œèƒ½ç¼“å­˜å¤šå¤§èŒƒå›´çš„åœ°å€ä¹Ÿæ˜¯è¢«è®¾å®šå¥½çš„ï¼Œè€Œ**å¯¹äºç»„ä¸­çš„è¡Œå°±æ˜¯é‡‡ç”¨ç¼“å­˜æ›¿æ¢ç­–ç•¥æ¥è¿›è¡Œé‡å¤ä½¿ç”¨çš„**

è¿™æ ·å°±é’ˆå¯¹ç¼“å­˜ç»„ã€ç¼“å­˜è¡Œåˆ†åˆ«å†™ä¸ªç»“æ„ä½“æˆ–è€…ç±»ï¼Œç„¶åå®ç°å¤„ç†æŒ‡ä»¤å’Œç¼“å­˜æ›¿æ¢ä»¥åŠè¾“å‡ºä¿¡æ¯çš„åŠŸèƒ½å°±å¯ä»¥äº†

æˆ‘çš„ä»£ç ï¼š
```cpp
#include "cachelab.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

typedef struct cache_line
{
    int valid;         // æœ‰æ•ˆä½
    int tag;           // æ ‡è®°ä½
    int last_vis_time; // æœ€è¿‘ä¸€æ¬¡è®¿é—®æ—¶é—´æˆ³
    char *data_;
} cache_line_;
typedef struct cache_set
{
    cache_line_ *cache_line;
} cache_set_;
typedef struct cache
{
    int S; // åŒ…å«Sä¸ªç¼“å­˜ç»„
    int E; // æ¯ä¸ªç¼“å­˜ç»„åŒ…å«çš„ç¼“å­˜è¡Œæ•°é‡
    int B; // æ¯ä¸ªç¼“å­˜è¡ŒåŒ…å«çš„å­—èŠ‚æ•°é‡
    cache_set_ *cache_set;
} cache_;

void init(cache_ *cache, int s, int E, int b) // Cè¯­è¨€æ²¡æœ‰æ„é€ å‡½æ•°ï¼Œåªèƒ½å•ç‹¬å®šä¹‰ä¸€ä¸ªåˆå§‹åŒ–å‡½æ•°
{
    cache->S = 1 << s;
    cache->E = E;
    cache->B = 1 << b;
    cache->cache_set = (cache_set_ *)malloc(sizeof(cache_set_) * cache->S); // ä¸ºSä¸ªç¼“å­˜ç»„ç”³è¯·å†…å­˜
    for (int i = 0; i < cache->S; i++)
    {
        // ä¸ºæ¯ä¸ªç»„çš„Eä¸ªç¼“å­˜è¡Œç”³è¯·å†…å­˜
        cache->cache_set[i].cache_line = (cache_line_ *)malloc(sizeof(cache_line_) * cache->E);
        // ç¼“å­˜è¡Œåˆå§‹åŒ–ï¼Œå¹¶ä¸ºæ¯ä¸ªç¼“å­˜è¡Œçš„æ•°æ®å—ç”³è¯·å†…å­˜
        for (int j = 0; j < cache->E; j++)
        {
            // æœ¬labä¸­ä¸æ¶‰åŠå®é™…çš„æ•°æ®å­˜å‚¨ï¼Œå› æ­¤ä¸éœ€è¦ç»™ç¼“å­˜è¡Œçš„æ•°æ®å—ç”³è¯·ç©ºé—´
            // cache->cache_set[i].cache_line[j].data_ = (char *)malloc(sizeof(char) * cache->B);
            cache->cache_set[i].cache_line[j].valid = 0;
            cache->cache_set[i].cache_line[j].tag = 0;
            cache->cache_set[i].cache_line[j].last_vis_time = 0;
        }
    }
}
void del(cache_ *cache)
{
    for (int i = 0; i < cache->S; i++)
    {
        // // é‡Šæ”¾æ¯ä¸ªç¼“å­˜è¡Œçš„æ•°æ®å—ç©ºé—´
        // for (int j = 0; j < cache->E; j++)
        // {
        //     free(cache->cache_set[i].cache_line[j].data_);
        // }

        // é‡Šæ”¾æ¯ä¸ªç¼“å­˜ç»„çš„ç¼“å­˜è¡Œç©ºé—´
        free(cache->cache_set[i].cache_line);
    }
    free(cache->cache_set); // é‡Šæ”¾ç¼“å­˜ç»„ç©ºé—´
    free(cache);            // é‡Šæ”¾ç¼“å­˜æŒ‡é’ˆ
}

// å®šä¹‰å®Œäº†æ•°æ®ç»“æ„ä»¥åŠåˆå§‹åŒ–ã€åˆ é™¤å‡½æ•°ï¼Œæ¥ä¸‹æ¥æŠŠæŸ¥æ‰¾ç¼“å­˜ã€ç¼“å­˜æ›¿æ¢éœ€è¦çš„å‡½æ•°å®šä¹‰ä¸€ä¸‹

// æŸ¥æ‰¾ç¼“å­˜ï¼Œå‚æ•°ä¸ºç¼“å­˜ç»„æŒ‡é’ˆcache_setï¼Œæ ‡è®°ä½tag
int find(cache_ *cache, int set_index, int tag, int time)
{
    for (int i = 0; i < cache->E; i++)
    {
        if (cache->cache_set[set_index].cache_line[i].valid &&
            cache->cache_set[set_index].cache_line[i].tag == tag)
        {
            cache->cache_set[set_index].cache_line[i].last_vis_time = time;
            return 1;
        }
    }
    return 0;
}
int IsFull(cache_ *cache, int set_index) // åˆ¤æ–­cacheçš„ç¼–å·ä¸ºset_indexçš„ç¼“å­˜ç»„æ˜¯å¦å·²æ»¡
{
    for (int i = 0; i < cache->E; i++)
    {
        if (cache->cache_set[set_index].cache_line[i].valid == 0)
            return 0;
    }
    return 1;
}
// ç¼“å­˜é©±é€ï¼Œå‚æ•°ä¸ºç¼“å­˜ç»„æŒ‡é’ˆcache_set
int evict(cache_ *cache, int set_index)
{ // æœ€é«˜æ•ˆçš„å†™æ³•åº”è¯¥ç”¨å“ˆå¸Œè¡¨+åŒå‘é“¾è¡¨ï¼Œä½†æ˜¯è¿™é‡Œåªèƒ½ç”¨cè¯­è¨€ï¼Œhashè¡¨éœ€è¦è‡ªå·±å®ç°ï¼Œå°±å…ˆç›´æ¥é€šè¿‡éå†ä¸Šä¸€æ¬¡æ—¶é—´æˆ³æ¥å®ç°äº†
    int min_time = 0x3f3f3f3f, evict_idx = 0;
    for (int i = 0; i < cache->E; i++)
    {
        if (cache->cache_set[set_index].cache_line[i].last_vis_time < min_time)
        {
            min_time = cache->cache_set[set_index].cache_line[i].last_vis_time;
            evict_idx = i;
        }
    }
    return evict_idx;
}
// æ•°æ®åŠ è½½åˆ°ç¼“å­˜ï¼Œå‚æ•°ä¸ºç¼“å­˜ç»„æŒ‡é’ˆcache_setï¼Œæ ‡è®°ä½tag
int insert(cache_ *cache, int set_index, int tag, int time)
{
    int line_idx = 0;
    if (IsFull(cache, set_index))
    {
        line_idx = evict(cache, set_index);
        cache->cache_set[set_index].cache_line[line_idx].tag = tag;
        cache->cache_set[set_index].cache_line[line_idx].last_vis_time = time;
        return 1;
    }
    for (int i = 0; i < cache->E; i++)
    {
        if (cache->cache_set[set_index].cache_line[i].valid == 0)
        {
            line_idx = i;
            break;
        }
    }
    cache->cache_set[set_index].cache_line[line_idx].valid = 1;
    cache->cache_set[set_index].cache_line[line_idx].tag = tag;
    cache->cache_set[set_index].cache_line[line_idx].last_vis_time = time;
    return 0;
}

// å†™å‡ºäº†ç¼“å­˜éœ€è¦çš„å‡½æ•°å®šä¹‰åï¼Œå…ˆä¸ç€æ€¥å®ç°ï¼Œå…ˆå¯¹æŠŠå¯¹traceæŒ‡ä»¤çš„è¯»å–å¤„ç†å®ç°ä¸€ä¸‹
int change2num(char *s)
{
    int res = 0;
    for (int i = 0; s[i]; i++)
    {
        res *= 10;
        res += s[i] - '0';
    }
    return res;
}

void solveTrace(int s, int E, int b, FILE *fp)
{
    cache_ *cache;
    cache = (cache_ *)malloc(sizeof(cache_));
    init(cache, s, E, b);
    int hit = 0, miss = 0, eviction = 0;
    int time = 0; // æ—¶é—´æˆ³

    // å¤„ç†æ–‡ä»¶è¾“å…¥
    char opt[31];
    // fgets(char* s,int n,FILE *stream) ä»streamè¯»å–å­—ç¬¦ä¸²ï¼Œè¯»å–åˆ°nä¸ªå­—ç¬¦ï¼Œæˆ–è€…è¯»å–åˆ°ä¸€è¡Œæœ«å°¾ï¼Œæˆ–è€…è¯»å–åˆ°æ–‡ä»¶æœ«å°¾åˆ™ç»“æŸ
    while (fgets(opt, 30, fp))
    {
        time++;
        // printf("%s", opt);
        char c[2];
        int addr, size;
        sscanf(opt, "%s %x,%d", c, &addr, &size);
        // printf("%s %d %d\n", c, addr, size);

        int tag = addr >> (s + b);                                  // æ ‡è®°ä½
        int set_index = (addr >> b) & ((unsigned)(-1) >> (32 - s)); // ç»„ç¼–å·

        if (c[0] == 'L' || c[0] == 'S')
        {
            if (find(cache, set_index, tag, time))
            {
                hit++;
                printf("%s %x,%d hit\n", c, addr, size);
            }
            else
            {
                miss++;
                printf("%s %x,%d miss ", c, addr, size);
                if (insert(cache, set_index, tag, time))
                {
                    eviction++;
                    printf("eviction");
                }
                printf("\n");
            }
        }
        else if (c[0] == 'M')
        {
            if (find(cache, set_index, tag, time))
            {
                hit += 2;
                printf("%s %x,%d hit hit\n", c, addr, size);
            }
            else
            {
                miss++;
                printf("%s %x,%d miss ", c, addr, size);
                if (insert(cache, set_index, tag, time))
                {
                    eviction++;
                    printf("eviction ");
                }
                hit++;
                printf("hit\n");
            }
        }
    }
    printSummary(hit, miss, eviction);
    del(cache);
}

void solve(int argc, char *argv[])
{
    int s, E, b;
    FILE *fp; // æ–‡ä»¶æŒ‡é’ˆ
    for (int i = 1; i < argc; i++)
    {
        // printf("%d %s\n", i, argv[i]);
        if (argv[i][0] == '-')
        {
            if (argv[i][1] == 's')
            {
                i++;
                s = change2num(argv[i]);
            }
            else if (argv[i][1] == 'E')
            {
                i++;
                E = change2num(argv[i]);
            }
            else if (argv[i][1] == 'b')
            {
                i++;
                b = change2num(argv[i]);
            }
            else if (argv[i][1] == 't')
            {
                i++;
                printf("%s\n", argv[i]);
                fp = fopen(argv[i], "r");
            }
        }
    }
    solveTrace(s, E, b, fp);
}

int main(int argc, char *argv[]) // argcä¸ºå‚æ•°æ•°é‡ã€argvä¸ºå‚æ•°ï¼Œå…¶ä¸­argv[0]ä¸ºç¨‹åºå
{
    solve(argc, argv);
    // printSummary(0, 0, 0);
    return 0;
}
```

æµ‹è¯•ç»“æœï¼š
```shell
root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# ./csim -s 1 -E 1 -b 1 -t traces/yi2.trace
traces/yi2.trace
hits:9 misses:8 evictions:6
root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# ./csim-ref -s 1 -E 1 -b 1 -t traces/yi2.trace
hits:9 misses:8 evictions:6

root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# ./csim -s 4 -E 2 -b 4 -t traces/yi.trace
traces/yi.trace
hits:4 misses:5 evictions:2
root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# ./csim-ref -s 4 -E 2 -b 4 -t traces/yi.trace
hits:4 misses:5 evictions:2

root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# ./csim -s 2 -E 1 -b 4 -t traces/dave.trace
traces/dave.trace
hits:2 misses:3 evictions:1
root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# ./csim-ref -s 2 -E 1 -b 4 -t traces/dave.trace
hits:2 misses:3 evictions:1

root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# ./csim -s 2 -E 1 -b 3 -t traces/trans.trace
traces/trans.trace
hits:167 misses:71 evictions:67
root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# ./csim-ref -s 2 -E 1 -b 3 -t traces/trans.trace
hits:167 misses:71 evictions:67

root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# ./csim -s 2 -E 2 -b 3 -t traces/trans.trace
traces/trans.trace
hits:201 misses:37 evictions:29
root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# ./csim-ref -s 2 -E 2 -b 3 -t traces/trans.trace
hits:201 misses:37 evictions:29

root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# ./csim -s 2 -E 4 -b 3 -t traces/trans.trace
traces/trans.trace
hits:212 misses:26 evictions:10
root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# ./csim-ref -s 2 -E 4 -b 3 -t traces/trans.trace
hits:212 misses:26 evictions:10

root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# ./csim -s 5 -E 1 -b 5 -t traces/trans.trace
traces/trans.trace
hits:231 misses:7 evictions:0
root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# ./csim-ref -s 5 -E 1 -b 5 -t traces/trans.trace
hits:231 misses:7 evictions:0

root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# ./csim -s 5 -E 1 -b 5 -t traces/long.trace
traces/long.trace
hits:265189 misses:21775 evictions:21743
root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# ./csim-ref -s 5 -E 1 -b 5 -t traces/long.trace
hits:265189 misses:21775 evictions:21743

root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# ./test-csim
                        Your simulator     Reference simulator
Points (s,E,b)    Hits  Misses  Evicts    Hits  Misses  Evicts
     3 (1,1,1)       9       8       6       9       8       6  traces/yi2.trace
     3 (4,2,4)       4       5       2       4       5       2  traces/yi.trace
     3 (2,1,4)       2       3       1       2       3       1  traces/dave.trace
     3 (2,1,3)     167      71      67     167      71      67  traces/trans.trace
     3 (2,2,3)     201      37      29     201      37      29  traces/trans.trace
     3 (2,4,3)     212      26      10     212      26      10  traces/trans.trace
     3 (5,1,5)     231       7       0     231       7       0  traces/trans.trace
     6 (5,1,5)  265189   21775   21743  265189   21775   21743  traces/long.trace
    27

TEST_CSIM_RESULTS=27
```

### Part B: Optimizing Matrix Transpose

åœ¨`trans.c`æ–‡ä»¶ä¸­å®ç°çŸ©é˜µè½¬ç½®å‡½æ•°ï¼Œå°½é‡ä½¿å…¶è¿è¡Œæ—¶ç¼“å­˜çš„missæ¬¡æ•°å°½å¯èƒ½å°‘ï¼Œæµ‹è¯•æ ·ä¾‹åŒ…æ‹¬32Ã—32ã€64Ã—64ä»¥åŠ61Ã—67ä¸‰ç§çŸ©é˜µï¼Œå¯ä»¥åˆ†åˆ«å¯¹ä¸‰ç§çŸ©é˜µå•ç‹¬ç¼–å†™å‡½æ•°åšä¼˜åŒ–

![](./assets/5.%20lab5-Cache%20Lab/2023-08-16-15-41-15.png)

è¦æ±‚ï¼š
* æœ€å¤šåªèƒ½ä½¿ç”¨12ä¸ªä¸´æ—¶å˜é‡
* ä¸èƒ½ä¿®æ”¹æ•°ç»„Aï¼Œå¯ä»¥ä¿®æ”¹æ•°ç»„B

trans.cä¸­å·²ç»ç»™å®šäº†ä¸€ä¸ªçŸ©é˜µè½¬ç½®å‡½æ•°çš„ç®€å•æ ·ä¾‹ï¼š
```cpp
char trans_desc[] = "Simple row-wise scan transpose";
void trans(int M, int N, int A[N][M], int B[M][N])
{
    int i, j, tmp;

    for (i = 0; i < N; i++)
    {
        for (j = 0; j < M; j++)
        {
            tmp = A[i][j];
            B[j][i] = tmp;
        }
    }
}
```

#### 32Ã—32

æµ‹è¯•ï¼š
The autograder takes the matrix size as input. It uses *valgrind* to generate a trace of each registered transpose function. It then evaluates each trace by running the reference simulator on a cache with parameters (s = 5, E = 1, b = 5).
For example, to test your registered transpose functions on a 32 Ã— 32 matrix, rebuild *test-trans*, and then run it with the appropriate values for M and N:
```shell
linux> make
linux> ./test-trans -M 32 -N 32
Step 1: Evaluating registered transpose funcs for correctness:
func 0 (Transpose submission): correctness: 1
func 1 (Simple row-wise scan transpose): correctness: 1
func 2 (column-wise scan transpose): correctness: 1
func 3 (using a zig-zag access pattern): correctness: 1
Step 2: Generating memory traces for registered transpose funcs.
Step 3: Evaluating performance of registered transpose funcs (s=5, E=1, b=5)
func 0 (Transpose submission): hits:1766, misses:287, evictions:255
func 1 (Simple row-wise scan transpose): hits:870, misses:1183, evictions:1151
func 2 (column-wise scan transpose): hits:870, misses:1183, evictions:1151
func 3 (using a zig-zag access pattern): hits:1076, misses:977, evictions:945
Summary for official submission (func 0): correctness=1 misses=287
```

In this example, we have registered four different transpose functions in trans.c. The test-trans program tests each of the registered functions, displays the results for each, and extracts the results for the official submission.

è¿è¡Œäº†./test-transåï¼Œä¼šç”Ÿæˆå¯¹trans.cä¸­æŒ‡å®šå‡½æ•°çš„traceï¼Œå¯¹funiçš„traceå‘½åä¸º `trace.fi`ï¼Œå¯ä»¥ä½¿ç”¨part Aä¸­çš„ç¼“å­˜æ¨¡æ‹Ÿå™¨å»å¯¹ç”Ÿæˆçš„traceè¿›è¡Œæ¨¡æ‹Ÿï¼Œä»è€Œå¾—åˆ°æ˜¯å“ªäº›åœ°æ–¹å‡ºç°äº†missï¼š

```shell
linux> ./csim-ref -v -s 5 -E 1 -b 5 -t trace.f0
S 68312c,1 miss
L 683140,8 miss
L 683124,4 hit
L 683120,4 hit
L 603124,4 miss eviction
S 6431a0,4 miss
...
```

![](./assets/5.%20lab5-Cache%20Lab/2023-08-15-14-55-08.png)

å…ˆç›´æ¥è¿è¡Œä¸€æ¬¡æ ·ä¾‹å‡½æ•°ï¼Œå¾—åˆ°trace1ï¼Œç„¶åçœ‹çœ‹èƒ½ä¸èƒ½åˆ†æå‡ºæ¥ä¸€äº›ä¿¡æ¯

```shell
root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# make
# Generate a handin tar file each time you compile
tar -cvf root-handin.tar  csim.c trans.c
csim.c
trans.c
root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# ./test-trans -M 32 -N 32

Function 0 (2 total)
Step 1: Validating and generating memory traces
Step 2: Evaluating performance (s=5, E=1, b=5)
func 0 (Transpose submission): hits:869, misses:1184, evictions:1152

Function 1 (2 total)
Step 1: Validating and generating memory traces
Step 2: Evaluating performance (s=5, E=1, b=5)
func 1 (Simple row-wise scan transpose): hits:869, misses:1184, evictions:1152

Summary for official submission (func 0): correctness=1 misses=1184

TEST_TRANS_RESULTS=1:1184
```
```shell
root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# ./csim-ref -v -s 5 -E 1 -b 5 -t trace.f1
```
![](./assets/5.%20lab5-Cache%20Lab/2023-08-15-15-05-21.png)

å¯ä»¥çœ‹åˆ°ï¼Œé™¤äº†å‰4è¡Œæ¯”è¾ƒç‰¹æ®Šå¤–ï¼Œåé¢ååˆ†æœ‰è§„å¾‹ï¼Œæ©™è‰²æ¡†æ¡†èµ·æ¥çš„æŒ‡ä»¤å’Œç»¿è‰²æ¡†æ¡†èµ·æ¥çš„æŒ‡ä»¤äº¤é”™å‡ºç°ï¼Œæ©™è‰²æŒ‡ä»¤å…¨éƒ¨ä¸ºloadï¼Œä¸”è®¿é—®çš„å†…å­˜åœ°å€ä¹‹é—´å‡ç›¸å·®0x4ï¼Œè€Œç»¿è‰²æŒ‡ä»¤å…¨éƒ¨ä¸ºstoreï¼Œè®¿é—®çš„å†…å­˜åœ°å€ä¹‹å‰å‡ç›¸å·®0x80

å†å›é¡¾ä¸€ä¸‹æ ·ä¾‹ç¨‹åº
```cpp
void trans(int M, int N, int A[N][M], int B[M][N])
{
    int i, j, tmp;

    for (i = 0; i < N; i++)
    {
        for (j = 0; j < M; j++)
        {
            tmp = A[i][j];
            B[j][i] = tmp;
        }
    }
}
```

Nå’ŒMå‡ä¸º32ï¼Œå¾ˆæ˜æ˜¾ä¸¤æ¡äº¤é”™å‡ºç°çš„æŒ‡ä»¤å’ŒNã€Mæ— å…³ï¼Œé‚£å°±åº”å½“æ˜¯`tmp = A[i][j];B[j][i] = tmp;`è¿™ä¸¤å¥äº†ï¼Œloadæ˜¯ä»å†…å­˜åŠ è½½åˆ°ç¼“å­˜ï¼Œå¯¹åº”`tmp=A[i][j]`ï¼Œä¸”åœ°å€å¢é‡ä¸º0x4ï¼Œä¹Ÿæ­£å¥½å¯¹åº”è¿™ä¸ªå¾ªç¯é‡Œé¢å†…å¾ªç¯æ˜¯jåœ¨ä¸æ–­++ï¼Œå¯¹äºA[i][j]æ¥è¯´æ˜¯4ä¸ªå­—èŠ‚4ä¸ªå­—èŠ‚é¡ºåºè®¿é—®çš„ï¼Œè€Œstoreæ˜¯ä»ç¼“å­˜å­˜å‚¨åˆ°å†…å­˜ï¼Œå¯¹åº”`B[j][i]=tmp`ï¼Œj++å¯¹äºB[j][i]æ¥è¯´æ˜¯æ¯æ¬¡è·³è¿‡äº†32ä¸ªå…ƒç´ è¿›è¡Œè®¿é—®çš„ï¼Œ32*4æ­£å¥½å¯¹åº”åœ°å€å¢é‡0x80

ç°åœ¨æ¥çœ‹çœ‹ä»€ä¹ˆæƒ…å†µä¸‹å‡ºç°äº†ç¼“å­˜miss

ç”±äºs=5ï¼ŒE=1ï¼Œb=5æ˜¯é¢„å…ˆè®¾å®šå¥½çš„ï¼Œå³å…±æœ‰32ä¸ªç¼“å­˜ç»„ï¼Œæ¯ä¸ªç¼“å­˜ç»„æœ‰ä¸€ä¸ªç¼“å­˜è¡Œï¼Œ**æ¯ä¸ªç¼“å­˜è¡Œæœ‰32ä¸ªå­—èŠ‚ï¼Œå¯ä»¥æƒ³åˆ°æ¯å½“è®¿é—®åˆ°æŸä¸€ä¸ª32å­—èŠ‚çš„è¿ç»­å†…å­˜æ—¶ï¼Œç¬¬ä¸€ä¸ª4å­—èŠ‚missä¹‹åï¼Œåé¢è‹¥ç»§ç»­è¿ç»­è®¿é—®ï¼Œåˆ™åé¢7ä¸ª4å­—èŠ‚éƒ½å¯ä»¥å‘½ä¸­**ï¼Œè§‚å¯Ÿä¸€ä¸‹ï¼Œå‘½ä¸­æƒ…å†µä¹Ÿç¡®å®å¦‚æ­¤ï¼Œ**å¯¹äºloadå‘½ä»¤ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹æ¯8æ¬¡éƒ½æ˜¯å‘½ä¸­7æ¬¡ï¼Œè¿˜æœ‰ä¸€äº›æƒ…å†µæ˜¯storeå‘½ä»¤ä¸loadå‘½ä»¤çš„ç¼“å­˜ç»„å†²çªäº†**ï¼Œä»è€ŒæŠŠloadå‘½ä»¤çš„ç¼“å­˜ç»™ç½®æ¢äº†å‡ºå»

è€Œå¯¹äºstoreå‘½ä»¤ï¼Œ**æ¯æ¬¡è®¿é—®éƒ½æ˜¯ç›¸éš”128ä¸ªå­—èŠ‚ï¼Œå³ç›¸å·®4ä¸ªç¼“å­˜ç»„ï¼Œè€Œæ¯å½“8æ¬¡è®¿é—®ï¼Œå›åˆ°ç¬¬ä¸€æ¬¡è®¿é—®æ—¶æ‰€åœ¨çš„ç¼“å­˜ç»„æ—¶ï¼Œå·²ç»å’Œä¸Šæ¬¡è®¿é—®è¿™ä¸ªç»„æ—¶ç›¸è·äº†1024å­—èŠ‚ï¼Œåˆéœ€è¦é‡æ–°åŠ è½½æ•°æ®åˆ°ç¼“å­˜**ï¼Œå› æ­¤**å…¨éƒ¨missäº†**ï¼Œä¸ä»…å¦‚æ­¤ï¼Œæ¯æ¬¡missæ—¶å°†å…¶åŠ è½½åˆ°ç¼“å­˜ä¸­è¿˜é€ æˆäº†ç¼“å­˜æ±¡æŸ“ï¼Œå¯¼è‡´loadå‘½ä»¤çš„ç¼“å­˜å‘½ä¸­ç‡é™ä½

è§‚å¯Ÿåœ°å€ä¿¡æ¯è¿˜å¯ä»¥å‘ç°ï¼Œ**Bæ•°ç»„å’ŒAæ•°ç»„ä¸­ä¸‹æ ‡ç›¸åŒçš„å…ƒç´ **å¯¹åº”çš„**ç¼“å­˜ç»„**å’Œ**åç§»é‡**éƒ½æ˜¯**ç›¸åŒ**çš„ï¼Œåªæ˜¯**æ ‡è®°ä½ä¸åŒ**ï¼Œå› æ­¤æˆ‘ä»¬è¿˜å¯ä»¥è®¡ç®—ä¸€ä¸‹Bæ•°ç»„å¯¼è‡´äº†Aæ•°ç»„å¤šäº†å¤šå°‘æ¬¡miss

**è®¿é—®Bæ•°ç»„æ—¶å…¨éƒ¨miss**ï¼Œå…±32Ã—32=**1024ä¸ª**

**Aæ•°ç»„æ¯8ä¸ªå…ƒç´ æœ‰ä¸€æ¬¡å†·ä¸å‘½ä¸­**ï¼Œå…±1024/8=**128ä¸ª**

Bæ•°ç»„æ¯æ¬¡è·³4ä¸ªç¼“å­˜ç»„è¿›è¡Œè®¿é—®ï¼ŒAæ•°ç»„æ¯æ¬¡è®¿é—®çŸ©é˜µä¸€æ•´è¡Œï¼Œä¼šè®¿é—®åˆ°4ä¸ªç¼“å­˜ç»„ï¼ŒBæ•°ç»„è®¿é—®ä¸€æ•´åˆ—ï¼Œä¼šè®¿é—®åˆ°8ä¸ªç¼“å­˜ç»„ï¼Œä¾‹å¦‚å¯¹äºç¬¬1è¡Œï¼Œè®¾ç¬¬1è¡Œå‰8ä¸ªå…ƒç´ å¯¹åº”çš„ç¼“å­˜è¡Œä¸º0ï¼Œåˆ™Aè®¿é—®åˆ°ç¼“å­˜è¡Œ0ã€1ã€2ã€3ï¼ŒBè®¿é—®åˆ°0ã€4ã€8ã€12ã€16ã€20ã€24ã€28

Aæ•°ç»„æ¯è®¿é—®8è¡Œï¼Œå³è®¿é—®8Ã—32Ã—4=32Ã—32ä¸ªå­—èŠ‚ï¼Œå°±ä¼šå†æ¬¡è®¿é—®åˆ°æœ€å¼€å§‹çš„ç¼“å­˜ç»„ï¼Œä¾‹å¦‚ï¼Œè®¾ç¬¬1è¡Œå‰8ä¸ªå…ƒç´ å¯¹åº”çš„ç¼“å­˜è¡Œä¸º0ï¼Œåˆ™Aæ•°ç»„è®¿é—®åˆ°ç¬¬9è¡Œæ—¶ï¼Œå‰8ä¸ªå…ƒç´ å¯¹åº”çš„ç¼“å­˜è¡Œä¹Ÿä¸º0ï¼Œè®¿é—®åˆ°ç¼“å­˜è¡Œ0ã€1ã€2ã€3ï¼Œè€ŒBè®¿é—®åˆ°1ã€5ã€9ã€13ã€17ã€21ã€25ã€29

**Aæ•°ç»„æ¯æ¬¡è®¿é—®ä¸€è¡Œï¼ŒBæ•°ç»„æ¯æ¬¡è®¿é—®ä¸€åˆ—**ï¼ŒBæ•°ç»„ä¸­**æ€»ä¼šè®¿é—®åˆ°ä¸€ä¸ªå’ŒAæ•°ç»„åæ ‡é‡å çš„å…ƒç´ **ï¼Œå³**å¯¹è§’çº¿ä½ç½®çš„å…ƒç´ **ï¼Œå®ƒä»¬çš„ç¼“å­˜ç»„ç›¸åŒï¼Œä»è€Œå¯¼è‡´ç¼“å­˜åˆ·æ–°ä¸€æ¬¡ï¼Œä½¿å¾—Aæ•°ç»„å¤šäº†ä¸€æ¬¡miss

è¿™æ ·å¯¼è‡´Aæ•°ç»„**å¤šmissäº†32æ¬¡**ï¼Œä½†æ˜¯è¿˜è¦å‡å»**é™¤äº†å¤„äºå¯¹è§’çº¿ï¼Œä¸”å¤„äºä¸€ä¸ªç¼“å­˜ç»„æœ«å°¾çš„é‚£å‡ ä¸ªå…ƒç´ (ä¸‹å›¾ä¸­æ ‡è“çš„ä½ç½®ï¼Œè¿™å‡ ä¸ªä½ç½®éƒ½å¤„äºä¸€ä¸ªç¼“å­˜ç»„çš„æœ«å°¾ï¼Œå…ˆload Aæ•°ç»„çš„å€¼ï¼Œå†storeåˆ°Bæ•°ç»„ä¹‹åï¼ŒAæ•°ç»„å°±ä¸å†è®¿é—®è¿™ä¸ªç¼“å­˜ç»„äº†ï¼Œä¸ä¼šå†äº§ç”Ÿå†²çªæœªå‘½ä¸­)ï¼Œä¸€å…±4ä¸ª**ï¼Œå› æ­¤å†²çªå¯¼è‡´Aæ•°ç»„å¤šmissäº†**28æ¬¡**
![](./assets/5.%20lab5-Cache%20Lab/2023-08-16-14-21-19.png)

1024+128+28=**1180æ¬¡**ï¼Œå¯¹åº”äº†å‰é¢çš„ç»“æœï¼š`func 1 (Simple row-wise scan transpose): hits:869, misses:1184, evictions:1152`ï¼Œè¿˜æœ‰4æ¬¡æ˜¯å¼€å¤´çš„3ä¸ªå’Œæœ«å°¾çš„1ä¸ªä¸å¾ªç¯æ— å…³çš„æŒ‡ä»¤é€ æˆçš„miss

![](./assets/5.%20lab5-Cache%20Lab/2023-08-16-14-17-31.png)
![](./assets/5.%20lab5-Cache%20Lab/2023-08-16-14-18-10.png)

æ—¢ç„¶æ˜¯ä¸è¿ç»­çš„å†…å­˜è®¿é—®é€ æˆçš„missï¼Œå°±è¦æƒ³åŠæ³•è®©å†…å­˜è®¿é—®å˜æˆé¡ºåºçš„ï¼Œäºæ˜¯æˆ‘ä»¬é¦–å…ˆè¦è§‚å¯Ÿä¸€ä¸‹çŸ©é˜µè½¬ç½®å‰åå…ƒç´ çš„ä½ç½®å˜åŒ–æƒ…å†µ

è®¾çŸ©é˜µè¡Œæ•°ä¸ºnï¼Œåˆ—æ•°ä¸ºmï¼Œå®é™…åœ¨å†…å­˜ä¸­æ˜¯ä¸€é•¿æ¡n\*mä¸ªå…ƒç´ é¡ºåºå­˜æ”¾çš„ï¼Œå¯ä»¥æŠŠè¿™ä¸€é•¿æ¡åˆ†ä¸ºnç»„ï¼Œæ¯ç»„mä¸ªå…ƒç´ ï¼Œè½¬ç½®å°±æ˜¯è®©ç¬¬iç»„çš„ç¬¬jä¸ªå…ƒç´ ç§»åŠ¨åˆ°ç¬¬jç»„çš„ç¬¬iä¸ªä½ç½®ï¼Œç§»åŠ¨å‰å’Œç§»åŠ¨åçš„åœ°å€ä¹‹é—´ç›¸å·®(j-i)\*m+i+m-j=(j-i)\*(m-1)+m=(j-i+1)\*(m-1)+1

iå’Œjè¶Šæ¥è¿‘ï¼Œè®¿é—®åˆ°çš„å…ƒç´ ç§»åŠ¨å‰åä½ç½®è¶Šæ¥è¿‘ï¼Œå³è·å¯¹è§’çº¿çš„è·ç¦»è¶Šè¿‘ï¼Œç§»åŠ¨å‰åä¸¤ä¸ªä½ç½®çš„åœ°å€è¶Šè¿‘

é‚£ä¹ˆæ²¿ç€å¯¹è§’çº¿æ–¹å‘èµ‹å€¼å‘¢ï¼Ÿå³ä»å·¦ä¸Šåˆ°å³ä¸‹ï¼Œi++,j++ï¼Œä»å³ä¸‹åˆ°å·¦ä¸Šï¼Œi--,j--

å³ä¸€ä¸ªçŸ©é˜µä»n,0å¼€å§‹éå†ï¼Œå¦ä¸€ä¸ªä»0,må¼€å§‹éå†
åæ ‡å˜åŒ–é¡ºåºï¼š
n,0 -> 
n,1 -> n-1,0 -> 
n-2,0 -> n-1,1 -> n,2 ->
n,3 -> n-1,2 -> n-2,1 -> n-3,0 ->
n-4,0 -> n-3,1 -> n-2,2 -> n-1,3 -> n,4 ->
...

åœ°å€çš„å˜åŒ–ï¼š
+4
-(m+1)\*4ã€-m\*4
+(m+1)\*4ã€+(m+1)\*4ã€+4
-(m+1)\*4ã€-(m+1)\*4ã€-(m+1)\*4ã€-m\*4
+(m+1)\*4ã€+(m+1)\*4ã€+(m+1)\*4ã€+(m+1)\*4ã€+4
...

ç”»ä¸ªå›¾çœ‹çœ‹

![](./assets/5.%20lab5-Cache%20Lab/2023-08-16-10-36-16.png)

é¢ã€‚ã€‚ç»“æœå°±æ˜¯ä»€ä¹ˆéƒ½æ²¡åˆ†æå‡ºæ¥ï¼Œä¸è¿‡è¿™ä¸ªå›¾ä¹Ÿä½“ç°å‡ºäº†ä¸€ç‚¹ä¸œè¥¿ï¼Œ**è‹¥çŸ©é˜µä¸­æ¯è¡Œå…ƒç´ æ•°é‡ä¸ç­‰äºä¸€ä¸ªç¼“å­˜è¡Œèƒ½ç¼“å­˜çš„å…ƒç´ æ•°é‡çš„æ•´æ•°å€ï¼Œè¿™æ ·å¾ˆå¤šåœ°æ–¹å¹¶ä¸æ˜¯å¯¹é½çš„**ï¼Œåˆè¦å¦‚ä½•å¤„ç†

æ²¿å¯¹è§’çº¿åªèƒ½ä¿è¯AçŸ©é˜µå’ŒBçŸ©é˜µçš„è®¿é—®æ¨¡å¼åŸºæœ¬ä¸€æ ·ï¼Œä½†æ˜¯å¹¶ä¸èƒ½è®©é¡ºåºè®¿é—®æ•°é‡å¢åŠ ï¼Œå¯¹äºå¢å¤§ç¼“å­˜å‘½ä¸­ç‡ä¸ä¸€å®šæœ‰å¥½å¤„

çœ‹äº†ä¸‹çŸ¥ä¹ï¼Œç„¶ååˆå»æŠŠlabç»™çš„è¡¥å……ææ–™çœ‹äº†ï¼Œå¥½åƒæ˜¯è‡ªå·±çš„æ€è·¯åäº†ï¼Œ**ä¸åº”è¯¥æ€»æƒ³ç€æ€ä¹ˆå»æ„é€ äº§ç”Ÿå°½å¯èƒ½å¤šçš„é¡ºåºè®¿é—®**ï¼ŒBæ•°ç»„missçš„**æœ¬è´¨åŸå› åœ¨äºè®¿é—®çš„åœ°å€è·¨åº¦è¿‡å¤§**ï¼Œå¯¼è‡´**ç¼“å­˜å®¹çº³ä¸ä¸‹**ï¼Œ**æ¯ä¸ªå¾ªç¯å‘¨æœŸéƒ½missä»¥åŠåˆ·æ–°**ï¼Œä¼˜åŒ–çš„å…³é”®ç‚¹è€Œæ˜¯åœ¨äº**ç»™çŸ©é˜µåˆ†å—**ï¼Œä¸ç®¡æ¯è¡Œæ¯åˆ—åœ°å€æ€ä¹ˆå˜åŒ–ï¼Œ**ä¸»è¦èšç„¦äºæŸä¸€å—ï¼Œè®©ç¼“å­˜æ¯æ¬¡ç¼“å­˜ä¸€æ•´å—å¯ä»¥å®¹çº³å¾—ä¸‹çš„å­çŸ©é˜µ**

å‰é¢åˆ†æmissæ•°é‡ä¹Ÿå‘ç°äº†ï¼Œå¯¹äºAæ•°ç»„çš„é¡ºåºè®¿é—®æ²¡æœ‰ä»€ä¹ˆåŠæ³•ä¼˜åŒ–äº†ï¼Œè¦ä¼˜åŒ–çš„ä¸»è¦åœ¨äºBæ•°ç»„çš„missï¼Œä»¥åŠBæ•°ç»„å¯¹Aæ•°ç»„é€ æˆçš„miss

**åˆ†å—ä»‹ç»**ï¼š
![](./assets/5.%20lab5-Cache%20Lab/2023-08-16-11-40-21.png)
![](./assets/5.%20lab5-Cache%20Lab/2023-08-16-11-41-44.png)
![](./assets/5.%20lab5-Cache%20Lab/2023-08-16-11-43-02.png)
```cpp
void bijk(array A, array B, array C, int n, int bsize)
{
    int i, j, k, kk, jj;
    double sum;
    int en = bsize * (n/bsize); /* Amount that fits evenly into blocks */

    for (i = 0; i < n; i++)
        for (j = 0; j < n; j++)
            C[i][j] = 0.0;

    for (kk = 0; kk < en; kk += bsize) 
    {
        for (jj = 0; jj < en; jj += bsize) 
        {
            for (i = 0; i < n; i++) 
            {
                for (j = jj; j < jj + bsize; j++) 
                {
                    sum = C[i][j];
                    for (k = kk; k < kk + bsize; k++) 
                    {
                        sum += A[i][k]*B[k][j];
                    }
                    C[i][j] = sum;
                }
            }
        }
    }
}
```
![](./assets/5.%20lab5-Cache%20Lab/2023-08-16-11-43-14.png)
![](./assets/5.%20lab5-Cache%20Lab/2023-08-16-11-49-40.png)

æ€»è€Œè¨€ä¹‹ï¼Œå¯¹çŸ©é˜µçš„åˆ†å—å°±æ˜¯**æ ¹æ®ç¼“å­˜çš„å¤§å°æ¥ç¡®å®šçŸ©é˜µåˆ†å—å¤§å°**ï¼Œç„¶åé€šè¿‡ä¸€æ¬¡ç¼“å­˜ä¸€æ•´å—çŸ©é˜µï¼Œä¸€æ¬¡å¯¹ä¸€æ•´å—çŸ©é˜µè¿›è¡Œå¤„ç†ï¼Œå¢å¤§ç©ºé—´å±€éƒ¨æ€§(ä»¥åŠå¯èƒ½å¢å¤§æ—¶é—´å±€éƒ¨æ€§)

å›åˆ°çŸ©é˜µè½¬ç½®é—®é¢˜ä¸Šï¼Œè¦ä½¿å¾—Bæ•°ç»„ä¸missï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†çŸ©é˜µåˆ†å—åè¿›è¡Œè½¬ç½®ï¼Œåœ¨ä¿è¯ç¼“å­˜å¯ä»¥å®¹çº³çš„å¤§å°ä¸‹è¿›è¡Œæ“ä½œ

32ä¸ªç¼“å­˜ç»„ï¼Œæ¯ä¸ªå¯ä»¥å®¹çº³32å­—èŠ‚ï¼Œå…±32Ã—32å­—èŠ‚=16Ã—16ä¸ª4å­—èŠ‚ï¼Œè€Œç”±äºéœ€è¦åŒæ—¶ç¼“å­˜Aæ•°ç»„å’ŒBæ•°ç»„ï¼Œå› æ­¤**å¯ä»¥é€‰å–8Ã—8å¤§å°è¿›è¡Œåˆ†å—**(åˆ—æ•°éœ€è¦ä¸ºä¸€ä¸ªç¼“å­˜è¡Œèƒ½å®¹çº³å…ƒç´ æ•°é‡(8)çš„æ•´æ•°å€ã€è¡Œæ•°å’Œåˆ—æ•°å‡éœ€è¦å°½é‡èƒ½æ•´é™¤çŸ©é˜µçš„æ€»è¡Œæ•°å’Œæ€»åˆ—æ•°)

ä»£ç ï¼š
```cpp
void transpose_submit(int M, int N, int A[N][M], int B[M][N])
{
    int i, j, k, l;

    for (i = 0; i < N; i += 8)
    {
        for (j = 0; j < M; j += 8)
        {
            for (k = i; k < i + 8; k++)
            {
                for (l = j; l < j + 8; l++)
                {
                    B[l][k] = A[k][l];
                }
            }
        }
    }
}
```

æµ‹è¯•ç»“æœï¼š
```shell
root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# ./test-trans -M 32 -N 32

Function 0 (2 total)
Step 1: Validating and generating memory traces
Step 2: Evaluating performance (s=5, E=1, b=5)
func 0 (Transpose submission): hits:1709, misses:344, evictions:312

Function 1 (2 total)
Step 1: Validating and generating memory traces
Step 2: Evaluating performance (s=5, E=1, b=5)
func 1 (Simple row-wise scan transpose): hits:869, misses:1184, evictions:1152

Summary for official submission (func 0): correctness=1 misses=344

TEST_TRANS_RESULTS=1:344
```

```shell
root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# ./csim-ref -v -s 5 -E 1 -b 5 -t trace.f0
S 10c080,1 miss
L 18c0c0,8 miss
L 18c0a4,4 miss
L 18c0a0,4 hit
# ä»è¿™é‡Œå¾ªç¯å¼€å§‹

L 10c0a0,4 miss eviction # Aæ•°ç»„ç¬¬1è¡Œç¬¬1ä¸ªå…ƒç´ ï¼Œç¼“å­˜ç»„0(å‡è®¾çš„ï¼Œæ²¡æœ‰ä¸“é—¨å»å¯¹ç…§åœ°å€è®¡ç®—å®é™…çš„ç¼“å­˜ç»„ç¼–å·ï¼Œåé¢çš„ç¼“å­˜ç»„ç¼–å·ä»¥æ­¤ç±»æ¨)ï¼Œå†·ä¸å‘½ä¸­
S 14c0a0,4 miss eviction # Bæ•°ç»„ç¬¬1è¡Œç¬¬1ä¸ªå…ƒç´ ï¼Œå†·ä¸å‘½ä¸­ï¼Œç¼“å­˜ç»„0ï¼Œå°†Aæ•°ç»„çš„ç¼“å­˜é©±é€äº†å‡ºå»
L 10c0a4,4 miss eviction # Aæ•°ç»„ç¬¬1è¡Œç¬¬2ä¸ªå…ƒç´ ï¼Œç¼“å­˜ç»„0ï¼Œç”±äºä¸Bæ•°ç»„çš„å†²çªå¯¼è‡´æœªå‘½ä¸­
S 14c120,4 miss # Bæ•°ç»„ç¬¬2è¡Œç¬¬1ä¸ªå…ƒç´ ï¼Œç¼“å­˜ç»„4ï¼Œå†·ä¸å‘½ä¸­
L 10c0a8,4 hit
S 14c1a0,4 miss # Bæ•°ç»„ç¬¬3è¡Œç¬¬1ä¸ªå…ƒç´ ï¼Œç¼“å­˜ç»„8ï¼Œå†·ä¸å‘½ä¸­
L 10c0ac,4 hit
S 14c220,4 miss # Bæ•°ç»„ç¬¬4è¡Œç¬¬1ä¸ªå…ƒç´ ï¼Œç¼“å­˜ç»„12ï¼Œå†·ä¸å‘½ä¸­
L 10c0b0,4 hit
S 14c2a0,4 miss # Bæ•°ç»„ç¬¬5è¡Œç¬¬1ä¸ªå…ƒç´ ï¼Œç¼“å­˜ç»„16ï¼Œå†·ä¸å‘½ä¸­
L 10c0b4,4 hit
S 14c320,4 miss # Bæ•°ç»„ç¬¬6è¡Œç¬¬1ä¸ªå…ƒç´ ï¼Œç¼“å­˜ç»„20ï¼Œå†·ä¸å‘½ä¸­
L 10c0b8,4 hit
S 14c3a0,4 miss # Bæ•°ç»„ç¬¬7è¡Œç¬¬1ä¸ªå…ƒç´ ï¼Œç¼“å­˜ç»„24ï¼Œå†·ä¸å‘½ä¸­
L 10c0bc,4 hit
S 14c420,4 miss # Bæ•°ç»„ç¬¬8è¡Œç¬¬1ä¸ªå…ƒç´ ï¼Œç¼“å­˜ç»„28ï¼Œå†·ä¸å‘½ä¸­

L 10c120,4 miss eviction # Aæ•°ç»„ç¬¬2è¡Œç¬¬1ä¸ªå…ƒç´ ï¼Œç¼“å­˜ç»„4ï¼Œå†·ä¸å‘½ä¸­
S 14c0a4,4 miss eviction # Bæ•°ç»„ç¬¬9è¡Œç¬¬1ä¸ªå…ƒç´ ï¼Œç¼“å­˜ç»„0ï¼Œç”±äºå’ŒAæ•°ç»„çš„å†²çªï¼Œç°åœ¨å†æ¬¡å†·ä¸å‘½ä¸­
L 10c124,4 hit 
S 14c124,4 miss eviction # Bæ•°ç»„ç¬¬10è¡Œç¬¬1ä¸ªå…ƒç´ ï¼Œç¼“å­˜ç»„4ï¼Œå°†Aæ•°ç»„çš„ç¼“å­˜é©±é€äº†å‡ºå»
L 10c128,4 miss eviction # Aæ•°ç»„ç¬¬2è¡Œç¬¬2ä¸ªå…ƒç´ ï¼Œç¼“å­˜ç»„4ï¼Œç”±äºä¸Bæ•°ç»„çš„å†²çªå¯¼è‡´æœªå‘½ä¸­
S 14c1a4,4 hit
L 10c12c,4 hit
S 14c224,4 hit
L 10c130,4 hit
S 14c2a4,4 hit
L 10c134,4 hit
S 14c324,4 hit
L 10c138,4 hit
S 14c3a4,4 hit
L 10c13c,4 hit
S 14c424,4 hit

L 10c1a0,4 miss eviction
S 14c0a8,4 hit
L 10c1a4,4 hit
S 14c128,4 miss eviction
L 10c1a8,4 hit
S 14c1a8,4 miss eviction
L 10c1ac,4 miss eviction
```

å†æ¥**åˆ†æä¸€ä¸‹missæ•°é‡**ï¼Œæˆ‘ä»¬å‡è®¾ç¬¬1è¡Œçš„å‰8ä¸ªå…ƒç´ çš„åœ°å€å¯¹åº”ç¼“å­˜ç»„0(æŒ‰å®é™…åœ°å€è®¡ç®—ï¼Œå¯¹åº”çš„åº”å½“æ˜¯ç¼“å­˜ç»„5(0b00101)ï¼Œä½†è¿™é‡Œåªæ˜¯ä¸ºäº†åˆ†æï¼Œå°†ç¼–å·ä»¥æ­¤ç±»æ¨ï¼Œæ–¹ä¾¿åˆ†æå³å¯)

1. å¯¹äºç¬¬ä¸€è¡Œ8ä¸ªå…ƒç´ ï¼ŒAæ•°ç»„è®¿é—®äº†ç¼“å­˜ç»„0ï¼ŒBæ•°ç»„åˆ†åˆ«è®¿é—®äº†ç¼“å­˜ç»„0ã€4ã€8ã€12ã€16ã€20ã€24ã€28
    * Aæ•°ç»„å‡ºç°ä¸€æ¬¡å†·ä¸å‘½ä¸­å’Œä¸€æ¬¡ç”±ä¸Bæ•°ç»„çš„ç¼“å­˜ç»„å†²çªé€ æˆçš„miss
    * Bæ•°ç»„å…¨éƒ¨å†·ä¸å‘½ä¸­

2. å¯¹äºç¬¬äºŒè¡Œ8ä¸ªå…ƒç´ ï¼ŒAæ•°ç»„è®¿é—®äº†ç¼“å­˜ç»„4ï¼ŒBæ•°ç»„åˆ†åˆ«è®¿é—®äº†ç¼“å­˜ç»„0ã€4ã€8ã€12ã€16ã€20ã€24ã€28
    * Aæ•°ç»„å‡ºç°ä¸€æ¬¡å†·ä¸å‘½ä¸­å’Œä¸€æ¬¡ç”±ä¸Bæ•°ç»„çš„ç¼“å­˜ç»„å†²çªé€ æˆçš„miss
    * Bæ•°ç»„ç”±äºå‰ä¸€è¡Œå’ŒAæ•°ç»„å‡ºç°çš„ç¼“å­˜ç»„å†²çªï¼Œç°åœ¨å†æ¬¡äº§ç”Ÿä¸€æ¬¡missï¼Œç„¶åç”±äºæœ¬è¡Œå’ŒAæ•°ç»„å‡ºç°çš„ç¼“å­˜ç»„å†²çªï¼Œäº§ç”Ÿä¸€æ¬¡miss
3. å¯¹äºç¬¬ä¸‰è¡Œ8ä¸ªå…ƒç´ ï¼ŒAæ•°ç»„è®¿é—®äº†ç¼“å­˜ç»„8ï¼ŒBæ•°ç»„åˆ†åˆ«è®¿é—®äº†ç¼“å­˜ç»„0ã€4ã€8ã€12ã€16ã€20ã€24ã€28
    * Aæ•°ç»„å‡ºç°ä¸€æ¬¡å†·ä¸å‘½ä¸­å’Œä¸€æ¬¡ç”±ä¸Bæ•°ç»„çš„ç¼“å­˜ç»„å†²çªé€ æˆçš„miss
    * Bæ•°ç»„ç”±äºå‰ä¸€è¡Œå’ŒAæ•°ç»„å‡ºç°çš„ç¼“å­˜ç»„å†²çªï¼Œç°åœ¨å†æ¬¡äº§ç”Ÿä¸€æ¬¡missï¼Œç”±äºæœ¬è¡Œå’ŒAæ•°ç»„å‡ºç°çš„ç¼“å­˜ç»„å†²çªï¼Œäº§ç”Ÿä¸€æ¬¡miss
4. ...
...

å¯ä»¥å‘ç°ï¼Œ**Aæ•°ç»„æ¯è¡Œmiss 2æ¬¡ï¼Œä¸€æ¬¡å†·ä¸å‘½ä¸­ï¼Œä¸€æ¬¡ä¸Bæ•°ç»„å†²çªæœªå‘½ä¸­**ï¼Œè€ŒBæ•°ç»„é™¤äº†**éå†ç¬¬ä¸€è¡ŒBæ•°ç»„8ä¸ªå…¨éƒ¨miss**ï¼Œä¹‹å**æ¯è¡Œç”±äºä¸Aæ•°ç»„å‰ä¸€è¡Œä»¥åŠå½“å‰è¡Œçš„å†²çªäº§ç”Ÿ2æ¬¡miss**ï¼Œé™¤äº†ç¬¬1è¡Œå’Œç¬¬8è¡Œ

æ³¨æ„**ç¼“å­˜ç»„å†²çªåªå‡ºç°åœ¨å¯¹è§’çº¿ä½ç½®å¤„ï¼Œå¯¹è§’çº¿ä½ç½®å…ƒç´ åªæœ‰32ä¸ª**
![](./assets/5.%20lab5-Cache%20Lab/2023-08-16-14-00-32.png)

å› æ­¤**å¯¹è§’çº¿ä½ç½®çš„å­çŸ©é˜µ**å‘ç”Ÿmissçš„æƒ…å†µï¼š
* æ¯8ä¸ªå…ƒç´ ï¼ŒAæ•°ç»„å’ŒBæ•°ç»„åˆ†åˆ«ä¼šäº§ç”Ÿ1æ¬¡å†·ä¸å‘½ä¸­ (2Ã—8)
* æ¯æ¬¡ç¼“å­˜ç»„å†²çªä¼šä½¿å¾—Aæ•°ç»„å¤šäº§ç”Ÿ1æ¬¡missï¼ŒBæ•°ç»„å¤šäº§ç”Ÿ2æ¬¡miss (3Ã—8)
* **ç‰¹åˆ«çš„ï¼Œç¬¬1è¡Œå’Œç¬¬8è¡Œçš„ç¼“å­˜ç»„å†²çªåªä½¿Bæ•°ç»„å¤šäº§ç”Ÿ1æ¬¡miss(å› ä¸ºBæ•°ç»„çš„å†²çªæœªå‘½ä¸­æ¯æ¬¡æ¥è‡ªäºä¸Šä¸€è¡Œå’Œæœ¬è¡Œï¼Œå¯¹äºç¬¬1è¡Œï¼ŒBæ•°ç»„çš„å†·ä¸å‘½ä¸­å’Œå†²çªæœªå‘½ä¸­é‡å äº†ï¼Œå¯¹äºç¬¬8è¡Œï¼Œäº§ç”Ÿ1æ¬¡å†²çªæœªå‘½ä¸­åå°±ç»“æŸäº†ï¼Œæ²¡æœ‰ç¬¬9è¡Œäº†)ï¼Œç¬¬8è¡ŒAæ•°ç»„åªäº§ç”Ÿä¸€æ¬¡å†·å‘½ä¸­ï¼Œä¸äº§ç”Ÿå†²çªæœªå‘½ä¸­(è¿™ä¸ªåŸå› å’Œå‰é¢è¯´è¿‡çš„ä¸€æ ·ï¼Œå¤„äºä¸€ä¸ªç¼“å­˜ç»„æœ«å°¾çš„æƒ…å†µ)** (-1-1-1=-3)

2Ã—8+3Ã—8-3=**37æ¬¡**

å¯¹äº**éå¯¹è§’çº¿ä½ç½®çš„å­çŸ©é˜µ**å‘ç”Ÿmissçš„æƒ…å†µï¼š
* æ¯8ä¸ªå…ƒç´ ï¼ŒAæ•°ç»„å’ŒBæ•°ç»„åˆ†åˆ«äº§ç”Ÿ1æ¬¡å†·ä¸å‘½ä¸­

8Ã—2=**16æ¬¡**

* å…± 37Ã—4(å¯¹è§’çº¿å­çŸ©é˜µ4ä¸ª) + 16Ã—12(éå¯¹è§’çº¿å­çŸ©é˜µ12ä¸ª) = **340æ¬¡**
* æˆ–è€… (1024/8)Ã—2(å†·æœªå‘½ä¸­æ•°) + 32Ã—(1+2) - 3Ã—4 (å†²çªæœªå‘½ä¸­æ•°)= 256 + 96 - 12 = **340æ¬¡**

å¯¹åº”æµ‹è¯•ç»“æœï¼š`func 0 (Transpose submission): hits:1709, misses:344, evictions:312` (å¤šå‡ºçš„4ä¸ªå‰é¢è¯´è¿‡äº†ï¼Œæ˜¯å¼€å¤´çš„3ä¸ªå’Œæœ«å°¾çš„1ä¸ªä¸å¾ªç¯æ— å…³çš„æŒ‡ä»¤äº§ç”Ÿçš„miss)

> è¿™é‡Œè®¡ç®—è¿™ç§æƒ…å†µçš„missæ•°çœŸæ˜¯ç»™æˆ‘æ•´éº»äº†ï¼Œå°ç»†èŠ‚å¤ªå¤šäº†ï¼Œç‰¹åˆ«æ˜¯å†²çªæœªå‘½ä¸­çš„æƒ…å†µï¼Œè¿™é‡Œè€—äº†æˆ‘ä¸¤ä¸‰ä¸ªå°æ—¶ï¼Œè£‚å¼€ã€‚ã€‚ã€‚

åˆ†æå¾—è¿™ä¹ˆè¯¦ç»†äº†ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œé™¤äº†**256æ¬¡å†·æœªå‘½ä¸­æ— æ³•é¿å…**ï¼Œ**å°±åªå‰©ä¸‹å¤šå‡ºçš„84æ¬¡å†²çªæœªå‘½ä¸­äº†**ï¼Œå¦‚ä½•å°†è¿™äº›å†²çªæœªå‘½ä¸­ç»™æ¶ˆé™¤æ‰å‘¢ï¼Ÿ

æˆ‘ä»¬å·²ç»çŸ¥é“å†²çªæœªå‘½ä¸­æ˜¯å¯¹è§’çº¿ä½ç½®æ•°ç»„Aå’Œæ•°ç»„Bå¯¹åŒä¸€ä¸ªä¸‹æ ‡çš„å…ƒç´ è¿›è¡Œloadæˆ–storeå¯¼è‡´ç¼“å­˜åˆ·æ–°ï¼Œäº§ç”Ÿå†²çªè€Œé€ æˆçš„ï¼Œè€Œä¸”è¿™ä¸ªå†²çªäº§ç”Ÿçš„æœ¬è´¨æ˜¯å› ä¸º**æ•°ç»„Aå’Œæ•°ç»„Bäº¤é”™æ“ä½œå…ƒç´ **ï¼Œå³**æ•°ç»„A loadå¯¹è§’çº¿å…ƒç´ åï¼Œç´§æ¥ç€æ•°ç»„B storeå¯¹è§’çº¿å…ƒç´ ï¼Œå†ç´§æ¥ç€æ•°ç»„Aåˆloadå¯¹è§’çº¿å…ƒç´ çš„åä¸€ä¸ªå…ƒç´ **ï¼Œå¯¹äºè¿™ç§æƒ…å†µæˆ‘ä»¬æ¯”è¾ƒå¥½å¤„ç†ï¼Œ**å¯ä»¥ä¸€æ¬¡æ€§å°†æ•°ç»„Açš„8ä¸ªå…ƒç´ å…ˆå…¨éƒ¨è¯»å…¥ä¸´æ—¶å˜é‡ï¼Œå†ç»Ÿä¸€ç»™æ•°ç»„Bèµ‹å€¼**ï¼Œè¿™ç§æƒ…å†µå…±2Ã—32-2Ã—4=**56æ¬¡miss**(æ¯ä¸ªå¯¹è§’çº¿å­çŸ©é˜µçš„ç¬¬1è¡Œæ•°ç»„Bä¸äº§ç”Ÿæ­¤ç§å†²çªæœªå‘½ä¸­ï¼Œç¬¬8è¡Œæ•°ç»„Aä¸äº§ç”Ÿæ­¤ç§å†²çªæœªå‘½ä¸­)

ä½†**é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨éå†ä¸‹ä¸€è¡Œæ—¶ï¼Œæ•°ç»„Bå†ä½¿ç”¨åˆ°ä¸Šä¸€è¡Œå¯¹åº”çš„ç¼“å­˜ç»„æ—¶ï¼Œè¿˜æ˜¯ä¼šç”±äºæ•°ç»„Aåˆšæ‰çš„ä½¿ç”¨è€Œäº§ç”Ÿ1æ¬¡å†²çªæœªå‘½ä¸­**ï¼Œè¿™ç§æƒ…å†µå…±32Ã—1-1Ã—4=**28æ¬¡miss**(æ¯ä¸ªå¯¹è§’çº¿å­çŸ©é˜µçš„ç¬¬8è¡Œæ•°ç»„Bä¸äº§ç”Ÿæ­¤ç§å†²çªæœªå‘½ä¸­)

æˆ‘ä»¬å…ˆæŠŠç¬¬ä¸€ç§å†²çªæœªå‘½ä¸­æ¶ˆé™¤æ‰ï¼š
```cpp
void transpose_submit(int M, int N, int A[N][M], int B[M][N])
{
    int i, j, k, l;

    for (i = 0; i < N; i += 8)
    {
        for (j = 0; j < M; j += 8)
        {
            for (k = i; k < i + 8; k++)
            {
                int temp[8];
                for (l = j; l < j + 8; l++)
                {
                    temp[l - j] = A[k][l];
                }
                for (l = j; l < j + 8; l++)
                {
                    B[l][k] = temp[l - j];
                }
            }
        }
    }
}
```

æ¶ˆé™¤ä¹‹åç°åœ¨çš„æœªå‘½ä¸­æ•°åº”å½“ä¸º 340-56=**284æ¬¡**

æµ‹è¯•ç»“æœï¼š
```shell
root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# ./test-trans -M 32 -N 32

Function 0 (2 total)
Step 1: Validating and generating memory traces
Step 2: Evaluating performance (s=5, E=1, b=5)
func 0 (Transpose submission): hits:1765, misses:290, evictions:258

Function 1 (2 total)
Step 1: Validating and generating memory traces
Step 2: Evaluating performance (s=5, E=1, b=5)
func 1 (Simple row-wise scan transpose): hits:869, misses:1184, evictions:1152

Summary for official submission (func 0): correctness=1 misses=290

TEST_TRANS_RESULTS=1:290
```

è¿˜å¤šå‡ºçš„6æ¬¡missä¹Ÿæ˜¯å¼€å¤´å’Œç»“å°¾ä¸å¾ªç¯æ— å…³çš„æŒ‡ä»¤äº§ç”Ÿçš„
å¼€å¤´4æ¬¡ï¼š
![](./assets/5.%20lab5-Cache%20Lab/2023-08-16-15-10-53.png)
ç»“å°¾2æ¬¡ï¼š
![](./assets/5.%20lab5-Cache%20Lab/2023-08-16-15-11-39.png)

å¦‚ä½•æ¶ˆé™¤æœ€åå‰©ä¸‹çš„28æ¬¡å†²çªæœªå‘½ä¸­å‘¢

ç”±äºè¿™äº›missæ˜¯ç”±äºæ•°ç»„Béœ€è¦åå¤è®¿é—®æ¯ä¸€è¡Œï¼Œè€Œæ•°ç»„Aåœ¨å…¶é—´è®¿é—®äº†åŒä¸€è¡Œæ‰€å¼•èµ·çš„ï¼Œè€Œä»–ä»¬åˆå¿…é¡»å°†æ•´ä¸ªçŸ©é˜µæ¯ä¸ªå…ƒç´ éƒ½éå†åˆ°

å› æ­¤æˆ‘å¯¹è¿™ä¸ªé—®é¢˜çš„æŠ½è±¡æ˜¯è¿™ä¸ªæ ·å­çš„ï¼šä¸¤ä¸ªæŒ‡é’ˆéå†è¿™ä¸ª8Ã—8çš„çŸ©é˜µï¼Œä¸€ä¸ªæŒ‡é’ˆè®¿é—®è¿‡çš„è¡Œï¼Œåœ¨è¿™ä¸ªæŒ‡é’ˆæŠŠè¿™ä¸€è¡Œå…¨éƒ¨è®¿é—®å®Œå‰ï¼Œå¦ä¸€ä¸ªæŒ‡é’ˆä¸èƒ½ç¢°ï¼Œå°±åƒç»™è¡Œä¸Šäº†é”ï¼Œè¿™ä¸¤ä¸ªæŒ‡é’ˆçš„éå†è¡Œä¸ºæ²¿å¯¹è§’çº¿å¯¹ç§°ï¼Œ**åœ¨åªèƒ½ç”¨åˆ°8ä¸ªä¸´æ—¶å˜é‡çš„æ¡ä»¶ä¸‹**ï¼Œå¦‚ä½•è®©å®ƒä»¬æŠŠæ•´ä¸ªçŸ©é˜µéƒ½éå†å®Œ

å®Œå…¨æ²¡æ€è·¯ã€‚ã€‚è¿˜æ˜¯çœ‹çœ‹çŸ¥ä¹å§

è¿˜æ˜¯è‡ªå·±çš„æ€è·¯åäº†ã€‚ã€‚ä¸åº”è¯¥æŠŠé—®é¢˜èšç„¦åœ¨å¦‚ä½•éå†ï¼Œè€Œæ˜¯éœ€è¦åˆ©ç”¨åˆ°ç©ºé—²çš„ç©ºé—´

åŸæ¥æ˜¯åˆ©ç”¨åˆ°äº†æ•°ç»„Bè®¿é—®ä¸€è¡Œåï¼Œå‰©ä¸‹çš„æ ¼å­æ•°ç»„Bè¦å¾ˆä¹…æ‰ä¼šè®¿é—®åˆ°ï¼Œåœ¨å…¶è®¿é—®åˆ°å‰©ä½™çš„æ ¼å­ä¹‹å‰ï¼Œè¿™äº›æ ¼å­éƒ½å¯ä»¥ç”¨æ¥ä¸´æ—¶å­˜å‚¨å…¶ä»–å€¼ï¼Œæ—¢ç„¶çŸ¥é“äº†è¿™ä¸ªæ€è·¯ï¼Œå°±å¥½åšäº†

è¿™æ ·å°±å¯ä»¥åœ¨ç”¨ä¸´æ—¶å˜é‡å°†æ•°ç»„Açš„ç¬¬1è¡Œå­˜èµ·æ¥ä¹‹åï¼Œå°†å®ƒä»¬éƒ½å…ˆä¾æ¬¡å­˜åˆ°æ•°ç»„Bçš„ç¬¬1è¡Œä¸­ï¼Œç„¶åå†ç”¨ä¸´æ—¶å˜é‡å°†æ•°ç»„Açš„ç¬¬2è¡Œå­˜èµ·æ¥ï¼Œç„¶åå°†æ•°ç»„Bç¬¬ä¸€è¡Œçš„ç¬¬2ä¸ªæ•°å­˜åˆ°ç¬¬äºŒè¡Œçš„ç¬¬1ä¸ªä½ç½®ï¼Œå°†ç¬¬1ä¸ªä¸´æ—¶å˜é‡(æ•°ç»„Açš„ç¬¬äºŒè¡Œç¬¬1ä¸ªæ•°)å­˜åˆ°æ•°ç»„Bç¬¬ä¸€è¡Œçš„ç¬¬2ä¸ªä½ç½®ï¼Œå³**æ²¿å¯¹è§’çº¿å¯¹ç§°äº¤æ¢**ï¼Œå‰©ä¸‹çš„ä¸´æ—¶å˜é‡å…¨éƒ¨ä¾æ¬¡å­˜åˆ°æ•°ç»„Bçš„ç¬¬äºŒè¡Œï¼Œä¾æ¬¡ç±»æ¨

**ä»£ç **(ç”±äºåªæœ‰å¯¹è§’çº¿å­çŸ©é˜µä¼šå‡ºç°å†²çªæœªå‘½ä¸­ï¼Œå› æ­¤è¿™æ¬¡ç›´æ¥å¯¹éè§’çº¿å­çŸ©é˜µå’Œå¯¹è§’çº¿å­çŸ©é˜µåšäº†åŒºåˆ†)ï¼š
```cpp
void transpose_submit(int M, int N, int A[N][M], int B[M][N])
{
    int i, j, k, l;
    int temp[8];
    for (i = 0; i < N; i += 8)
    {
        for (j = 0; j < M; j += 8)
        {
            for (k = i; k < i + 8; k++) // å­çŸ©é˜µçš„8è¡Œ
            {
                if (i != j) // éå¯¹è§’çº¿å­çŸ©é˜µ
                {
                    for (l = j; l < j + 8; l++) // å­çŸ©é˜µçš„8åˆ—
                        B[l][k] = A[k][l];
                }
                else // i==jï¼Œå¯¹è§’çº¿å­çŸ©é˜µ
                {
                    for (l = j; l < j + 8; l++) // å­çŸ©é˜µçš„8åˆ—
                        temp[l - j] = A[k][l];  // å–æ•°ç»„Açš„ç¬¬kè¡Œæš‚å­˜
                    for (l = j; l < j + 8; l++)
                    {
                        if (l < j + (k - i)) // å¯¹æ•°ç»„Bçš„ç¬¬kè¡Œå‰k-iä¸ªå…ƒç´ ä»¥åŠå®ƒä»¬çš„è½¬ç½®ä½ç½®çš„å…ƒç´ è¿›è¡Œèµ‹å€¼
                        {
                            B[k][l] = B[l][k];
                            B[l][k] = temp[l - j];
                        }
                        else
                            B[k][l] = temp[l - j];
                    }
                }
            }
        }
    }
}
```

æµ‹è¯•ç»“æœï¼š
```shell
root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# ./test-trans -M 32 -N 32

Function 0 (2 total)
Step 1: Validating and generating memory traces
Step 2: Evaluating performance (s=5, E=1, b=5)
func 0 (Transpose submission): hits:2081, misses:262, evictions:230

Function 1 (2 total)
Step 1: Validating and generating memory traces
Step 2: Evaluating performance (s=5, E=1, b=5)
func 1 (Simple row-wise scan transpose): hits:869, misses:1184, evictions:1152

Summary for official submission (func 0): correctness=1 misses=262

TEST_TRANS_RESULTS=1:262
```

å‡å»ä¸´æ—¶å˜é‡å¯¼è‡´çš„å¼€å¤´å’Œç»“å°¾éå¾ªç¯æŒ‡ä»¤ä¸­å‡ºç°çš„6ä¸ªmissï¼Œè¾¾åˆ°äº†ç†æƒ³æœ€ä½³æƒ…å†µï¼Œmissæ•°=256

#### 64Ã—64

å¯¹äº64Ã—64çš„çŸ©é˜µï¼Œåš8Ã—8çš„åˆ†å—ï¼Œå¯ä»¥åˆ†å‡º64ä¸ªå­çŸ©é˜µï¼Œ32Ã—32çŸ©é˜µçš„ä»£ç å¯ä»¥ç›´æ¥ç”¨å—ï¼Ÿ

å…ˆè¿è¡Œä¸‹è¯•è¯•

```shell
root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# ./test-trans -M 64 -N 64

Function 0 (2 total)
Step 1: Validating and generating memory traces
Step 2: Evaluating performance (s=5, E=1, b=5)
åˆ—
Function 1 (2 total)
Step 1: Validating and generating memory traces
Step 2: Evaluating performance (s=5, E=1, b=5)
func 1 (Simple row-wise scan transpose): hits:3473, misses:4724, evictions:4692

Summary for official submission (func 0): correctness=1 misses=4382

TEST_TRANS_RESULTS=1:4382
```
ã€‚ã€‚ã€‚ä¼˜åŒ–æ•ˆæœå¾®å°å¾—å¯æ€œï¼Œä¸ºå•¥

32Ã—32çŸ©é˜µå’Œ64Ã—64çŸ©é˜µç¼“å­˜ç»„çš„å¯¹åº”æƒ…å†µå¯¹æ¯”ï¼š

![](./assets/5.%20lab5-Cache%20Lab/2023-08-16-16-53-58.png)

å¯ä»¥çœ‹åˆ°ï¼Œ64Ã—64çŸ©é˜µç”±äºä¸€è¡Œå…ƒç´ çš„ä¸ªæ•°æ˜¯32Ã—32çŸ©é˜µçš„ä¸¤å€ï¼ŒåŒä¸€åˆ—ä¸­æ¯éš”4è¡Œå¯¹åº”çš„ç¼“å­˜ç»„å°±å¾ªç¯ä¸€æ¬¡ï¼Œè€Œ32Ã—32çŸ©é˜µæ˜¯æ¯éš”8è¡Œ

è€Œæ¯éš”4è¡Œï¼Œå…ƒç´ åœ°å€ç›¸å·®1024å­—èŠ‚ï¼Œè¿™å°±ä¼šé€ æˆè¿›è¡Œè½¬ç½®æ—¶ä¸ºBæ•°ç»„æ¯æ¬¡èµ‹å€¼8ä¸ªå…ƒç´ æ—¶ï¼Œå4ä¸ªå…ƒç´ ä¸å‰4ä¸ªå…ƒç´ ç¼“å­˜ç»„å†²çªï¼Œå¯¼è‡´Bæ•°ç»„ä¸æ–­å†²çªæœªå‘½ä¸­

Aæ•°ç»„å’ŒBæ•°ç»„çš„å†·ä¸å‘½ä¸­æ¬¡æ•°ï¼š64Ã—64/8*2=1024æ¬¡

ç°åœ¨æ¥è®¡ç®—Bçš„å†²çªæœªå‘½ä¸­æ¬¡æ•°

é¦–å…ˆå†è§‚å¯Ÿä¸€ä¸‹æˆ‘ä»¬å¾ªç¯çš„èµ‹å€¼æ–¹å¼ï¼Œå¯¹äºå¯¹è§’çº¿å­çŸ©é˜µï¼Œæ¯æ¬¡éå†Açš„ä¸€è¡Œï¼Œç”¨ä¸´æ—¶å˜é‡å­˜å‚¨ï¼Œç„¶åéå†Bçš„å¯¹åº”è¡Œï¼Œåœ¨å¯¹è§’çº¿ä¹‹å‰çš„ä½ç½®è¦å’Œå…¶è½¬ç½®åå¯¹åº”çš„ä½ç½®è¿›è¡Œäº¤æ¢ï¼Œå…¶ä½™çš„ç›´æ¥å­˜åˆ°Bçš„å¯¹åº”è¡Œï¼Œè¿™ä¸€æ­¥åœ¨è¡Œä¹‹é—´çš„ç¼“å­˜ç»„ä¸å†²çªæ—¶ä¸ä¼šäº§ç”Ÿè´Ÿæ‹…ï¼Œè€Œåœ¨å‰4è¡Œå’Œå4è¡Œçš„ç¼“å­˜ç»„å†²çªæ—¶ï¼Œåœ¨éå†å‰4è¡Œæ—¶ä¹Ÿä¸ä¼šäº§ç”Ÿå†²çªï¼Œè€Œåœ¨éå†å4è¡Œæ—¶ï¼Œåˆ™ä¼šç”±äºå†²çªå¯¼è‡´å†²çªæœªå‘½ä¸­

ä¸‹å›¾ä¸­é¢œè‰²ç›¸åŒçš„å³ä¸ºæ¯æ¬¡éå†ä¸€è¡Œæ—¶è¦äº¤æ¢çš„ä½ç½®ï¼Œè€Œç”¨å½©è‰²æ–¹æ¡†æ¡†èµ·æ¥çš„æ˜¯ä¸å‘ç”Ÿå†²çªçš„åŒºåŸŸï¼š
![](./assets/5.%20lab5-Cache%20Lab/2023-08-19-10-28-46.png)

å†²çªçš„æƒ…å†µï¼š
1. **ç¬¬iè¡Œç¬¬i%4ä¸ªå…ƒç´ ä¸ç¬¬iåˆ—ç¬¬i%4ä¸ªå…ƒç´ äº¤æ¢æ—¶ï¼Œå‘ç”Ÿ4æ¬¡å†²çª**
2. é™¤äº†ç¬¬ä¸€ç§æƒ…å†µï¼Œæ¯æ¬¡èµ‹å€¼æ—¶ç”±äºåˆ—æ˜¯4ä¸ªä¸ºä¸€ä¸ªå‘¨æœŸï¼Œ**å¯¹åˆ—ä¸­å•ä¸ªå…ƒç´ èµ‹å€¼æ—¶ä¹Ÿä¼šå’Œå‰é¢åˆ—çš„ç¼“å­˜ç»„ä»¥åŠä¸‹ä¸€è¡Œçš„ç¼“å­˜ç»„äº§ç”Ÿå†²çª**ï¼Œè¿™ç§å†²çªmissæ¯æ¬¡å•ä¸ªå•ä¸ªå‡ºç°

**å¯¹è§’çº¿å­çŸ©é˜µä¸­çš„å†²çªmissæ¬¡æ•°**ï¼š4-1(éå†ç¬¬5è¡Œæ—¶çš„å†²çªmissæ¬¡æ•°ï¼Œå’Œå†·ä¸å‘½ä¸­é‡å äº†1æ¬¡) + 1+4+1(éå†ç¬¬6è¡Œæ—¶çš„å†²çªmissæ¬¡æ•°) + 1+1+4+1+1(éå†ç¬¬7è¡Œæ—¶çš„å†²çªmissæ¬¡æ•°) + 1+1+1+4+1+1+1(éå†ç¬¬8è¡Œæ—¶çš„å†²çªmissæ¬¡æ•°)=3+6+8+10=**27æ¬¡**

å…± 27Ã—8=**216æ¬¡**

å¯¹äºéå¯¹è§’çº¿å­çŸ©é˜µï¼Œæˆ‘ä»¬æ˜¯ç›´æ¥å¯¹è½¬ç½®ä½ç½®èµ‹å€¼çš„ï¼Œç”±äºæ¯å‰4è¡Œå’Œå4è¡Œç¼“å­˜ç»„å†²çªï¼Œä¼šå¯¼è‡´å¯¹æ•°ç»„Bçš„è®¿é—®å…¨éƒ¨miss

**éå¯¹è§’çº¿å­çŸ©é˜µä¸­çš„å†²çªmissæ¬¡æ•°**ï¼š8Ã—8-8(å†·ä¸å‘½ä¸­æ¬¡æ•°)=**56æ¬¡**

å…±56Ã—(64-8)=**3136æ¬¡**

å…¨éƒ¨æ€»å…±ï¼š1024(å†·ä¸å‘½ä¸­)+216(å¯¹è§’çº¿å­çŸ©é˜µ)+3136(éå¯¹è§’çº¿å­çŸ©é˜µ)=**4376æ¬¡**

`func 0 (Transpose submission): hits:4393, misses:4382, evictions:4350`

å‡å»ä¸´æ—¶å˜é‡å¯¼è‡´çš„å¼€å¤´å’Œç»“å°¾éå¾ªç¯æŒ‡ä»¤ä¸­å‡ºç°çš„6ä¸ªmissï¼Œå’Œæµ‹è¯•ç»“æœç›¸åŒ¹é…

å› æ­¤è¿™é‡Œä¸»è¦è¦æ¶ˆé™¤çš„å°±æ˜¯åˆ—ä¸­çš„ç¼“å­˜ç»„å†²çª

å¦‚æœå°†8Ã—8æ¢æˆ4Ã—4çš„è¯ï¼Œå¯ä»¥å‡å°‘å¾ˆå¤šmissæ¬¡æ•°ï¼Œä½†æ˜¯ä¼šç”±äºè¿™ç§åˆ†å—æ–¹æ¡ˆäº§ç”Ÿæ›´å¤šçš„ä¸å¯é¿å…çš„å†²çªmiss

å…¶ä»–ä»€ä¹ˆéƒ½ä¸å˜ï¼ŒåªæŠŠä»£ç ä¸­çš„8æ”¹æˆ4ï¼Œæµ‹è¯•ç»“æœï¼š
```shell
func 0 (Transpose submission): hits:6641, misses:1750, evictions:1718
```

å› æ­¤æƒ³è¦å®Œå…¨æ¶ˆé™¤å†²çªmissï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¯¹8Ã—8åˆ†å—ä¸‹å­çŸ©é˜µçš„èµ‹å€¼æ–¹å¼è¿›è¡Œè¿›ä¸€æ­¥ä¼˜åŒ–

å…¶å®æŠŠéå¯¹è§’çº¿å­çŸ©é˜µçš„èµ‹å€¼æ–¹å¼æ”¹æˆå¯¹è§’çº¿çŸ©é˜µçš„èµ‹å€¼æ–¹å¼å°±å·²ç»å¯ä»¥æ¶ˆé™¤æ‰å¾ˆå¤šmissæ¬¡æ•°äº†ï¼Œä½†æ˜¯å¯¹è§’çº¿çŸ©é˜µå‘ç”Ÿå†²çªçš„æ–¹å¼ååˆ†å¤æ‚ï¼Œä¸çŸ¥é“è¦æ€ä¹ˆä¼˜åŒ–

å¯ä»¥å¯¹éå¯¹è§’çº¿çŸ©é˜µå’Œå¯¹è§’çº¿çŸ©é˜µåˆ†åˆ«è¿›è¡Œä¼˜åŒ–

çœ‹äº†ä¸€ä¸‹çŸ¥ä¹ä¸Šå¤§ä½¬çš„æ–‡ç« (https://zhuanlan.zhihu.com/p/387662272)ï¼Œå…ˆæŠŠéå¯¹è§’çº¿çŸ©é˜µçš„èµ‹å€¼ä¼˜åŒ–ä¸€ä¸‹

æ ¸å¿ƒæ€è·¯å°±æ˜¯**å°†8Ã—8çš„çŸ©é˜µåˆ†æˆ4ä¸ª4Ã—4çš„å­çŸ©é˜µåˆ†åˆ«è¿›è¡Œèµ‹å€¼**ï¼Œä½†æ˜¯å¯¹åŸçŸ©é˜µ**æŒ‰è¡Œéå†**ï¼Œå…¶ä¸­ç›®æ ‡çŸ©é˜µçš„**å·¦ä¸Šå’Œå³ä¸‹çŸ©é˜µç›´æ¥è½¬ç½®èµ‹å€¼**ï¼Œ**å³ä¸ŠçŸ©é˜µæš‚å­˜å·¦ä¸‹çŸ©é˜µçš„è½¬ç½®å€¼**ï¼Œåœ¨**éå†å4è¡Œæ—¶å†é€šè¿‡ä¸´æ—¶å˜é‡ç»Ÿä¸€å®Œæˆå³ä¸ŠçŸ©é˜µå’Œå·¦ä¸‹çŸ©é˜µçš„æŒ‰è¡Œèµ‹å€¼**

```cpp
if (i != j) // éå¯¹è§’çº¿å­çŸ©é˜µ
{
    for (k = i; k < i + 4; k++) // å‰4è¡Œ
    {
        for (l = j; l < j + 4; l++) // å‰4è¡Œå‰4åˆ—ï¼Œç›´æ¥è½¬ç½®ä½ç½®èµ‹å€¼
            B[l][k] = A[k][l];
        for (l = j + 4; l < j + 8; l++) // å‰4è¡Œå4åˆ—ï¼Œæš‚å­˜åœ¨å­çŸ©é˜µå³ä¸Šæ–¹
            B[l - 4][k + 4] = A[k][l];
    }
    for (k = i + 4; k < i + 8; k++) // å4è¡Œ
    {
        for (l = j; l < j + 4; l++) // å…ˆæŠŠå³ä¸Šè§’æš‚å­˜çš„ä¸€åˆ—4ä¸ªå€¼å–å‡ºæ¥
            temp[l - j] = B[l][k];
        for (l = j; l < j + 4; l++) // å4è¡Œå‰4åˆ—ï¼Œç»™å³ä¸Šè§’è½¬ç½®ä½ç½®èµ‹å€¼
            B[l][k] = A[k][l];
        for (l = j; l < j + 4; l++) // å†ç»™å·¦ä¸‹è§’å½“å‰è¡Œå‰4ä¸ªèµ‹å€¼
            B[l + 4][k - 4] = temp[l - j];
        for (l = j + 4; l < j + 8; l++) // æœ€åç»™å³ä¸‹è§’ä¸€è¡Œ4ä¸ªèµ‹å€¼
            B[l][k] = A[k][l];
    }
}
```

æµ‹è¯•ç»“æœï¼š
```shell
func 0 (Transpose submission): hits:7849, misses:2590, evictions:2558
```

æ€ä¹ˆå›äº‹ã€‚ã€‚missæ¬¡æ•°å‡å°‘çš„æ•°é‡å¥½åƒä¸å¤ªå¯¹åŠ²ï¼Œæ£€æŸ¥ä¸€ä¸‹å‘ç°ï¼Œæ˜¯éå†æ–¹å¼å‡ºäº†é—®é¢˜ï¼Œè¿™é‡Œä¸€å®šè¦æŠŠè¡Œå’Œåˆ—çš„å¯¹åº”å…³ç³»è¿˜æœ‰èµ‹å€¼é¡ºåºç†æ¸…æ¥š
```cpp
if (i != j) // éå¯¹è§’çº¿å­çŸ©é˜µ
{
    for (k = i; k < i + 4; k++) // å‰4è¡Œ
    {
        for (l = j; l < j + 4; l++) // å‰4è¡Œå‰4åˆ—ï¼Œç›´æ¥è½¬ç½®ä½ç½®èµ‹å€¼
            B[l][k] = A[k][l];
        for (l = j + 4; l < j + 8; l++) // å‰4è¡Œå4åˆ—ï¼Œæš‚å­˜åœ¨å­çŸ©é˜µå³ä¸Šæ–¹
            B[l - 4][k + 4] = A[k][l];
    }
    for (l = j; l < j + 4; l++) // å4è¡Œï¼ŒæŒ‰åˆ—éå†ï¼Œå…ˆéå†å‰4åˆ—
    {
        for (k = i + 4; k < i + 8; k++) // å…ˆæŠŠå³ä¸Šè§’æš‚å­˜çš„ä¸€è¡Œ4ä¸ªå€¼å–å‡ºæ¥
            temp[k - i - 4] = B[l][k];
        for (k = i + 4; k < i + 8; k++) // å4è¡Œå‰4åˆ—ï¼Œç»™å³ä¸Šè§’è½¬ç½®ä½ç½®çš„å¯¹åº”è¡Œèµ‹å€¼
            B[l][k] = A[k][l];
        for (k = i + 4; k < i + 8; k++) // å†ç»™å·¦ä¸‹è§’å½“å‰è¡Œå‰4ä¸ªèµ‹å€¼
            B[l + 4][k - 4] = temp[k - i - 4];
    }
    for (l = j + 4; l < j + 8; l++)
        for (k = i + 4; k < i + 8; k++) // å4è¡Œå4åˆ—
            B[l][k] = A[k][l];
}
```
æµ‹è¯•ç»“æœï¼š
```shell
func 0 (Transpose submission): hits:9193, misses:1246, evictions:1214
```

1024(å†·ä¸å‘½ä¸­æ•°)+216(å¯¹è§’çº¿å­çŸ©é˜µå†²çªä¸å‘½ä¸­æ•°)=1240æ¬¡

è¿™æ ·å°±åªå‰©ä¸‹å†·ä¸å‘½ä¸­å’Œå¯¹è§’çº¿å­çŸ©é˜µä¸­çš„å†²çªmissäº†

å¦‚ä½•ä¼˜åŒ–å¯¹è§’çº¿å­çŸ©é˜µå‘¢

å¯¹è§’çº¿å­çŸ©é˜µå­˜åœ¨çš„ä¸¤ç§å†²çªmissï¼š
1. æ•°ç»„Aå’Œæ•°ç»„Bç›¸åŒè¡Œæ˜ å°„åˆ°ç›¸åŒç¼“å­˜ç»„
    * é€šè¿‡ä¸€æ¬¡æ€§ç§»åŠ¨æ•°ç»„Açš„ä¸€è¡Œæ¥é¿å…å†²çª
2. æ•°ç»„Aã€Bçš„å‰4è¡Œå’Œå4è¡Œéƒ½æ˜ å°„åˆ°ç›¸åŒç¼“å­˜ç»„
    * ä¸ä»…ä¸€æ¬¡æ€§ç§»åŠ¨æ•°ç»„Açš„ä¸€è¡Œï¼ŒåŒæ—¶æ¯æ¬¡åªå¯¹4Ã—4çš„å­çŸ©é˜µè¿›è¡Œæ“ä½œ

å¦‚æœä½¿ç”¨å’Œéå¯¹è§’çº¿å­çŸ©é˜µç›¸åŒçš„æ€è·¯ï¼Œå¯¹4ä¸ª4Ã—4å­çŸ©é˜µåˆ†åˆ«æ“ä½œï¼Œç”±äº1. çš„é™åˆ¶ï¼Œä¼šæ²¡æœ‰åŠæ³•é¿å…Aå’ŒBç›¸åŒè¡Œçš„ç¼“å­˜ç»„å†²çªï¼Œå› æ­¤æˆ‘ä»¬åªèƒ½é¦–å…ˆä¸€æ¬¡å¤åˆ¶ä¸€è¡Œ

**åœ¨å¤åˆ¶å®Œæ•´ä¸ªå‰4è¡Œåï¼Œå¯¹äºå·¦ä¸Šè§’å’Œå³ä¸Šè§’çš„4Ã—4å­çŸ©é˜µï¼Œå¯ä»¥å¯¹Bæ•°ç»„è¿›è¡ŒåŸåœ°çš„è½¬ç½®ï¼Œè¿™æ ·å°±è¾¾åˆ°äº†å’Œéå¯¹è§’çº¿å­çŸ©é˜µç›¸åŒçš„æ•ˆæœ**

è€Œ**å¯¹äºå4è¡Œ**ï¼Œæ­¤å‰çš„æ€è·¯æ˜¯å…ˆå°†å³ä¸Šè§’çŸ©é˜µçš„ä¸€è¡Œæš‚å­˜ï¼Œç„¶åç»™å³ä¸Šè§’çŸ©é˜µèµ‹å€¼å®Œåï¼Œå†ç»™å·¦ä¸‹è§’çŸ©é˜µèµ‹å€¼ï¼Œç„¶è€Œå¯¹äºå¯¹è§’çº¿çŸ©é˜µï¼Œ**æ•°ç»„Açš„ç¬¬5ã€6ã€7ã€8è¡Œå’Œæ•°ç»„Bçš„1ã€2ã€3ã€4è¡Œä¹Ÿæ˜¯ç¼“å­˜ç»„å†²çªçš„**ï¼Œ**å¯¼è‡´æ²¡æœ‰åŠæ³•åŒæ—¶å¯¹å®ƒä»¬è¿›è¡Œäº¤æ›¿æ“ä½œ**ï¼Œæ—¢ç„¶æ˜¯**Aæ•°ç»„çš„è¡Œä¸Bæ•°ç»„çš„è¡Œå†²çªäº†**ï¼Œæˆ‘ä»¬**å°±å…ˆæŠŠAæ•°ç»„çš„å­çŸ©é˜µæš‚å­˜åˆ°Bæ•°ç»„çš„å…¶ä»–éå¯¹è§’çº¿å­çŸ©é˜µä¸­**ï¼Œ**é¿å…æ‰è¿™ç§ç¼“å­˜ç»„å†²çª**ï¼Œç„¶å**å†æŒ‰ç…§å’Œéå¯¹è§’çº¿å­çŸ©é˜µç›¸åŒçš„æ€è·¯**è¿›è¡Œèµ‹å€¼å°±å¯ä»¥äº†ï¼Œè€Œè¢«ä½œä¸ºæš‚å­˜åŒºåŸŸçš„å­çŸ©é˜µåªä¼šäº§ç”Ÿå†·ä¸å‘½ä¸­ï¼Œä¸”åœ¨è¢«å€Ÿç”¨åï¼Œå†å¯¹å®ƒä»¬è¿›è¡Œæ“ä½œæ—¶ï¼Œå°±ä¸ä¼šå†äº§ç”Ÿå†·ä¸å‘½ä¸­äº†ï¼ŒæŠµæ¶ˆæ‰äº†

ä¸è¿‡è¦æ³¨æ„ï¼Œè¿™æ ·éå†å­çŸ©é˜µçš„é¡ºåºä¹Ÿéœ€è¦ä¿®æ”¹ä¸€ä¸‹äº†ï¼Œå› ä¸ºæœ€åä¸€ä¸ªå¯¹è§’çº¿å­çŸ©é˜µæ˜¯æ‰€æœ‰å­çŸ©é˜µä¸­çš„æœ€åä¸€ä¸ªï¼Œå¦‚æœæŒ‰é¡ºåºéå†çš„è¯åˆ°æœ€åä¼šæ²¡æœ‰å¯ä»¥å€Ÿç”¨çš„éå¯¹è§’çº¿å­çŸ©é˜µåŒºåŸŸ

æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨å¤–å¾ªç¯ä¸­å¾ªç¯iæ—¶å°±ç›´æ¥å¯¹å¯¹è§’çº¿å­çŸ©é˜µå…ˆè¿›è¡Œå¤„ç†ï¼Œå³éå†æ¯è¡Œæ—¶å…ˆè¿›è¡Œå¯¹è§’çº¿å­çŸ©é˜µçš„å¤„ç†ï¼Œç„¶åå†é¡ºåºéå†å½“å‰è¡Œçš„å…¶ä»–å­çŸ©é˜µ

å¯¹æ•°ç»„Aæ˜¯æŒ‰è¡Œéå†ï¼Œåˆ™å¯¹äºæ•°ç»„Bå°±æ˜¯æŒ‰åˆ—éå†ï¼Œè€Œæ¯ä¸€åˆ—ä¸Šçš„å­çŸ©é˜µå¯¹åº”çš„ç¼“å­˜ç»„éƒ½æ˜¯ç›¸åŒçš„ï¼Œè¿™æ ·éå†çš„è¯åˆ°æœ€åä¸€ä¸ªå¯¹è§’çº¿å­çŸ©é˜µæ—¶èƒ½å€Ÿç”¨çš„å­çŸ©é˜µåªå‰©ä¸‹å…¶ä¸Šæ–¹çš„å­çŸ©é˜µäº†ï¼Œè¿™æ ·ä»ä¼šå¯¼è‡´ç¼“å­˜ç»„å†²çªï¼Œå› æ­¤æˆ‘ä»¬åº”è¯¥æ”¹å˜éå†é¡ºåºï¼Œå¯¹æ•°ç»„AæŒ‰åˆ—éå†ï¼Œè¿™æ ·å¯¹äºæ•°ç»„Bå°±æ˜¯æŒ‰è¡Œéå†äº†ï¼Œæ¯ä¸ªå¯¹è§’çº¿å­çŸ©é˜µç›´æ¥å€Ÿç”¨è¯¥è¡Œä¸­çš„ä»»æ„ä¸€ä¸ªå­çŸ©é˜µå°±å¯ä»¥äº†ï¼Œè¿™é‡Œæˆ‘é€‰å–å¯¹è§’çº¿å­çŸ©é˜µå·¦è¾¹ç›¸é‚»çš„å­çŸ©é˜µæš‚å­˜(ç¬¬ä¸€ä¸ªå¯¹è§’çº¿å­çŸ©é˜µé€‰å–å³è¾¹ç›¸é‚»çš„)

```cpp
i = j; // i==jï¼Œå¯¹è§’çº¿å­çŸ©é˜µ

for (k = i + 4; k < i + 8; k++) // å…ˆæŠŠçŸ©é˜µçš„å4è¡Œè½¬ç§»ä½ç½®
{
   // æŒ‰è¡Œæš‚å­˜åˆ°æ•°ç»„Bç›¸é‚»å­çŸ©é˜µçš„å¯¹åº”è¡Œ
   for (l = j; l < j + 8; l++)
       if (j == 0) // ç¬¬ä¸€è¡Œç¬¬ä¸€ä¸ªå¯¹è§’çº¿å­çŸ©é˜µ
           B[k][l + 8] = A[k][l];
       else // å…¶ä»–å¯¹è§’çº¿å­çŸ©é˜µ
           B[k][l - 8] = A[k][l];
}
for (k = i; k < i + 4; k++) // çŸ©é˜µçš„å‰4è¡ŒæŒ‰è¡Œæš‚å­˜åˆ°æ•°ç»„Bçš„å¯¹åº”è¡Œ
{
   for (l = j; l < j + 8; l++)
       temp[l - j] = A[k][l];
   for (l = j; l < j + 8; l++)
       B[k][l] = temp[l - j];
}
for (k = i; k < i + 4; k++) // å¯¹Bæ•°ç»„ä¸Šæ–¹çš„ä¸¤ä¸ªå­çŸ©é˜µè¿›è¡Œè½¬ç½®ï¼Œæ³¨æ„è¿™é‡Œå¾ªç¯åªèƒ½å¾ªç¯ä¸€åŠå…ƒç´ ï¼Œå¦åˆ™æ¯ä¸ªä½ç½®ä¼šäº¤æ¢ä¸¤æ¬¡
{
   for (l = j; l < j + k - i; l++) // å¯¹å·¦ä¸Šè§’å­çŸ©é˜µè¿›è¡Œè½¬ç½®å¤„ç†
   {
       temp[0] = B[k][l];
       B[k][l] = B[l][k];
       B[l][k] = temp[0];
   }
   for (l = j + 4; l < j + 4 + k - i; l++) // å¯¹å³ä¸Šè§’å­çŸ©é˜µè¿›è¡Œè½¬ç½®å¤„ç†
   {
       // k=iï¼Œl=j+4 => l-j-4+iï¼Œk-i+j+4
       temp[0] = B[k][l];
       B[k][l] = B[l - j - 4 + i][k - i + j + 4];
       B[l - j - 4 + i][k - i + j + 4] = temp[0];
   }
}
// ç„¶åå¥—ç”¨éå¯¹è§’çº¿å­çŸ©é˜µçš„é€»è¾‘å°±å¯ä»¥äº†
for (l = j; l < j + 4; l++) // å4è¡Œï¼ŒæŒ‰åˆ—éå†ï¼Œå…ˆéå†å‰4åˆ—
{
   for (k = i + 4; k < i + 8; k++) // å…ˆæŠŠå³ä¸Šè§’æš‚å­˜çš„ä¸€è¡Œ4ä¸ªå€¼å–å‡ºæ¥
       temp[k - i - 4] = B[l][k];
   for (k = i + 4; k < i + 8; k++) // å4è¡Œå‰4åˆ—ï¼Œç»™å³ä¸Šè§’è½¬ç½®ä½ç½®çš„å¯¹åº”è¡Œèµ‹å€¼
       if (j == 0)                 // ç¬¬ä¸€è¡Œç¬¬ä¸€ä¸ªå¯¹è§’çº¿å­çŸ©é˜µ
           B[l][k] = B[k][l + 8];
       else // å…¶ä»–å¯¹è§’çº¿å­çŸ©é˜µ
           B[l][k] = B[k][l - 8];
   for (k = i + 4; k < i + 8; k++) // å†ç»™å·¦ä¸‹è§’å½“å‰è¡Œå‰4ä¸ªèµ‹å€¼
       B[l + 4][k - 4] = temp[k - i - 4];
}
for (l = j + 4; l < j + 8; l++)
   for (k = i + 4; k < i + 8; k++) // å4è¡Œå4åˆ—
       if (j == 0)
           B[l][k] = B[k][l + 8];
       else
           B[l][k] = B[k][l - 8];
```

æµ‹è¯•ç»“æœï¼š
```shell
func 0 (Transpose submission): hits:10081, misses:1062, evictions:1030
```

ã€‚ã€‚ã€‚1062æ˜¯ä»€ä¹ˆé¬¼ï¼Œæ¯”1024+6=1030å¤šä¸ª32ä¸ªmissï¼Œè¿™æ˜¯ä¸ºå•¥

å“¦ï¼ŒåŸæ¥æ˜¯æˆ‘åœ¨å€Ÿç”¨BçŸ©é˜µä¸­éå¯¹è§’çº¿çŸ©é˜µçš„åŒºåŸŸæ—¶ï¼Œå€Ÿç”¨çš„æ˜¯å4è¡Œï¼Œä½†æ˜¯éå†åˆ°è¿™äº›çŸ©é˜µçš„æ—¶å€™ï¼Œä¼šé¦–å…ˆéå†å®ƒä»¬çš„å‰4è¡Œï¼Œè¿™æ ·å°±è¿˜æ˜¯äº§ç”Ÿäº†å†²çªï¼Œå› æ­¤åœ¨å€Ÿç”¨å®ƒä»¬çš„ç©ºé—´æ—¶ï¼Œå¿…é¡»å€Ÿç”¨å‰4è¡Œï¼Œå³xåæ ‡å‡4ï¼Œå°±å¯ä»¥äº†

```cpp
i = j; // i==jï¼Œå¯¹è§’çº¿å­çŸ©é˜µ

for (k = i + 4; k < i + 8; k++) // å…ˆæŠŠçŸ©é˜µçš„å4è¡Œè½¬ç§»ä½ç½®
{
   // æŒ‰è¡Œæš‚å­˜åˆ°æ•°ç»„Bç›¸é‚»å­çŸ©é˜µçš„å¯¹åº”è¡Œ
   for (l = j; l < j + 8; l++)
       if (j == 0) // ç¬¬ä¸€è¡Œç¬¬ä¸€ä¸ªå¯¹è§’çº¿å­çŸ©é˜µ
           B[k - 4][l + 8] = A[k][l];
       else // å…¶ä»–å¯¹è§’çº¿å­çŸ©é˜µ
           B[k - 4][l - 8] = A[k][l];
}
for (k = i; k < i + 4; k++) // çŸ©é˜µçš„å‰4è¡ŒæŒ‰è¡Œæš‚å­˜åˆ°æ•°ç»„Bçš„å¯¹åº”è¡Œ
{
   for (l = j; l < j + 8; l++)
       temp[l - j] = A[k][l];
   for (l = j; l < j + 8; l++)
       B[k][l] = temp[l - j];
}
for (k = i; k < i + 4; k++) // å¯¹Bæ•°ç»„ä¸Šæ–¹çš„ä¸¤ä¸ªå­çŸ©é˜µè¿›è¡Œè½¬ç½®ï¼Œæ³¨æ„è¿™é‡Œå¾ªç¯åªèƒ½å¾ªç¯ä¸€åŠå…ƒç´ ï¼Œå¦åˆ™æ¯ä¸ªä½ç½®ä¼šäº¤æ¢ä¸¤æ¬¡
{
   for (l = j; l < j + k - i; l++) // å¯¹å·¦ä¸Šè§’å­çŸ©é˜µè¿›è¡Œè½¬ç½®å¤„ç†
   {
       temp[0] = B[k][l];
       B[k][l] = B[l][k];
       B[l][k] = temp[0];
   }
   for (l = j + 4; l < j + 4 + k - i; l++) // å¯¹å³ä¸Šè§’å­çŸ©é˜µè¿›è¡Œè½¬ç½®å¤„ç†
   {
       // k=iï¼Œl=j+4 => l-j-4+iï¼Œk-i+j+4
       temp[0] = B[k][l];
       B[k][l] = B[l - j - 4 + i][k - i + j + 4];
       B[l - j - 4 + i][k - i + j + 4] = temp[0];
   }
}
// ç„¶åå¥—ç”¨éå¯¹è§’çº¿å­çŸ©é˜µçš„é€»è¾‘å°±å¯ä»¥äº†
for (l = j; l < j + 4; l++) // å4è¡Œï¼ŒæŒ‰åˆ—éå†ï¼Œå…ˆéå†å‰4åˆ—
{
   for (k = i + 4; k < i + 8; k++) // å…ˆæŠŠå³ä¸Šè§’æš‚å­˜çš„ä¸€è¡Œ4ä¸ªå€¼å–å‡ºæ¥
       temp[k - i - 4] = B[l][k];
   for (k = i + 4; k < i + 8; k++) // å4è¡Œå‰4åˆ—ï¼Œç»™å³ä¸Šè§’è½¬ç½®ä½ç½®çš„å¯¹åº”è¡Œèµ‹å€¼
       if (j == 0)                 // ç¬¬ä¸€è¡Œç¬¬ä¸€ä¸ªå¯¹è§’çº¿å­çŸ©é˜µ
           B[l][k] = B[k - 4][l + 8];
       else // å…¶ä»–å¯¹è§’çº¿å­çŸ©é˜µ
           B[l][k] = B[k - 4][l - 8];
   for (k = i + 4; k < i + 8; k++) // å†ç»™å·¦ä¸‹è§’å½“å‰è¡Œå‰4ä¸ªèµ‹å€¼
       B[l + 4][k - 4] = temp[k - i - 4];
}
for (l = j + 4; l < j + 8; l++)
   for (k = i + 4; k < i + 8; k++) // å4è¡Œå4åˆ—
       if (j == 0)
           B[l][k] = B[k - 4][l + 8];
       else
           B[l][k] = B[k - 4][l - 8];
```

å®Œæ•´ä»£ç ï¼š
```cpp
void transpose_64_plus_64(int M, int N, int A[N][M], int B[M][N])
{
    int i, j, k, l;
    int temp[8];
    for (j = 0; j < M; j += 8)
    {
        i = j; // i==jï¼Œå¯¹è§’çº¿å­çŸ©é˜µ

        for (k = i + 4; k < i + 8; k++) // å…ˆæŠŠçŸ©é˜µçš„å4è¡Œè½¬ç§»ä½ç½®
        {
            // æŒ‰è¡Œæš‚å­˜åˆ°æ•°ç»„Bç›¸é‚»å­çŸ©é˜µçš„å¯¹åº”è¡Œ
            for (l = j; l < j + 8; l++)
                if (j == 0) // ç¬¬ä¸€è¡Œç¬¬ä¸€ä¸ªå¯¹è§’çº¿å­çŸ©é˜µ
                    B[k - 4][l + 8] = A[k][l];
                else // å…¶ä»–å¯¹è§’çº¿å­çŸ©é˜µ
                    B[k - 4][l - 8] = A[k][l];
        }
        for (k = i; k < i + 4; k++) // çŸ©é˜µçš„å‰4è¡ŒæŒ‰è¡Œæš‚å­˜åˆ°æ•°ç»„Bçš„å¯¹åº”è¡Œ
        {
            for (l = j; l < j + 8; l++)
                temp[l - j] = A[k][l];
            for (l = j; l < j + 8; l++)
                B[k][l] = temp[l - j];
        }
        for (k = i; k < i + 4; k++) // å¯¹Bæ•°ç»„ä¸Šæ–¹çš„ä¸¤ä¸ªå­çŸ©é˜µè¿›è¡Œè½¬ç½®ï¼Œæ³¨æ„è¿™é‡Œå¾ªç¯åªèƒ½å¾ªç¯ä¸€åŠå…ƒç´ ï¼Œå¦åˆ™æ¯ä¸ªä½ç½®ä¼šäº¤æ¢ä¸¤æ¬¡
        {
            for (l = j; l < j + k - i; l++) // å¯¹å·¦ä¸Šè§’å­çŸ©é˜µè¿›è¡Œè½¬ç½®å¤„ç†
            {
                temp[0] = B[k][l];
                B[k][l] = B[l][k];
                B[l][k] = temp[0];
            }
            for (l = j + 4; l < j + 4 + k - i; l++) // å¯¹å³ä¸Šè§’å­çŸ©é˜µè¿›è¡Œè½¬ç½®å¤„ç†
            {
                // k=iï¼Œl=j+4 => l-j-4+iï¼Œk-i+j+4
                temp[0] = B[k][l];
                B[k][l] = B[l - j - 4 + i][k - i + j + 4];
                B[l - j - 4 + i][k - i + j + 4] = temp[0];
            }
        }
        // ç„¶åå¥—ç”¨éå¯¹è§’çº¿å­çŸ©é˜µçš„é€»è¾‘å°±å¯ä»¥äº†
        for (l = j; l < j + 4; l++) // å4è¡Œï¼ŒæŒ‰åˆ—éå†ï¼Œå…ˆéå†å‰4åˆ—
        {
            for (k = i + 4; k < i + 8; k++) // å…ˆæŠŠå³ä¸Šè§’æš‚å­˜çš„ä¸€è¡Œ4ä¸ªå€¼å–å‡ºæ¥
                temp[k - i - 4] = B[l][k];
            for (k = i + 4; k < i + 8; k++) // å4è¡Œå‰4åˆ—ï¼Œç»™å³ä¸Šè§’è½¬ç½®ä½ç½®çš„å¯¹åº”è¡Œèµ‹å€¼
                if (j == 0)                 // ç¬¬ä¸€è¡Œç¬¬ä¸€ä¸ªå¯¹è§’çº¿å­çŸ©é˜µ
                    B[l][k] = B[k - 4][l + 8];
                else // å…¶ä»–å¯¹è§’çº¿å­çŸ©é˜µ
                    B[l][k] = B[k - 4][l - 8];
            for (k = i + 4; k < i + 8; k++) // å†ç»™å·¦ä¸‹è§’å½“å‰è¡Œå‰4ä¸ªèµ‹å€¼
                B[l + 4][k - 4] = temp[k - i - 4];
        }
        for (l = j + 4; l < j + 8; l++)
            for (k = i + 4; k < i + 8; k++) // å4è¡Œå4åˆ—
                if (j == 0)
                    B[l][k] = B[k - 4][l + 8];
                else
                    B[l][k] = B[k - 4][l - 8];

        for (i = 0; i < N; i += 8)
        {
            if (i != j) // éå¯¹è§’çº¿å­çŸ©é˜µ
            {
                for (k = i; k < i + 4; k++) // å‰4è¡Œ
                {
                    for (l = j; l < j + 4; l++) // å‰4è¡Œå‰4åˆ—ï¼Œç›´æ¥è½¬ç½®ä½ç½®èµ‹å€¼
                        B[l][k] = A[k][l];
                    for (l = j + 4; l < j + 8; l++) // å‰4è¡Œå4åˆ—ï¼Œæš‚å­˜åœ¨å­çŸ©é˜µå³ä¸Šæ–¹
                        B[l - 4][k + 4] = A[k][l];
                }
                for (l = j; l < j + 4; l++) // å4è¡Œï¼ŒæŒ‰åˆ—éå†ï¼Œå…ˆéå†å‰4åˆ—
                {
                    for (k = i + 4; k < i + 8; k++) // å…ˆæŠŠå³ä¸Šè§’æš‚å­˜çš„ä¸€è¡Œ4ä¸ªå€¼å–å‡ºæ¥
                        temp[k - i - 4] = B[l][k];
                    for (k = i + 4; k < i + 8; k++) // å4è¡Œå‰4åˆ—ï¼Œç»™å³ä¸Šè§’è½¬ç½®ä½ç½®çš„å¯¹åº”è¡Œèµ‹å€¼
                        B[l][k] = A[k][l];
                    for (k = i + 4; k < i + 8; k++) // å†ç»™å·¦ä¸‹è§’å½“å‰è¡Œå‰4ä¸ªèµ‹å€¼
                        B[l + 4][k - 4] = temp[k - i - 4];
                }
                for (l = j + 4; l < j + 8; l++)
                    for (k = i + 4; k < i + 8; k++) // å4è¡Œå4åˆ—
                        B[l][k] = A[k][l];
            }
        }
    }
}
```

æµ‹è¯•ç»“æœï¼š
```shell
func 0 (Transpose submission): hits:10113, misses:1030, evictions:998
```

è¾¾åˆ°äº†æœ€ä¼˜è§£1024

#### 61Ã—67

61Ã—67çš„çŸ©é˜µå’Œå‰ä¸¤ç§çŸ©é˜µéƒ½ä¸ä¸€æ ·äº†ï¼Œå˜æˆäº†ä¸è§„åˆ™çš„çŸ©é˜µï¼Œç”¨å‰ä¸¤é—®çš„ä»£ç è¿è¡Œä¼šç›´æ¥å‡ºé”™

è€Œä¸”61å’Œ67éƒ½æ˜¯è´¨æ•°ï¼ŒçŸ©é˜µåˆ†å—ä¹Ÿä¸å¥½å®ç°äº†

61Ã—67=4087å¹¶ä¸èƒ½è¢«8æ•´é™¤ï¼Œåªèƒ½ç¡®å®šçš„æ˜¯ä»å¤´å¼€å§‹æ¯8ä¸ªå…ƒç´ ä¸€ä¸ªç¼“å­˜ç»„ï¼Œæ¯8Ã—32=256ä¸ªå…ƒç´ ç¼“å­˜ç»„å¾ªç¯ä¸€æ¬¡

æœ´ç´ å®ç°çš„missæ•°ï¼š
```shell
func 1 (Simple row-wise scan transpose): hits:3755, misses:4424, evictions:4392
```

æˆ‘ä»¬å…ˆæ¯æ¬¡æŒ‰8ä¸ªä¸€ç»„æ“ä½œä¼˜åŒ–ä¸€ä¸‹è¯•è¯•

```cpp
void transpose_submit(int M, int N, int A[N][M], int B[M][N])
{
    int i, j, k;
    int temp[8];
    i = 0, j = 0;
    while (1)
    {
        for (k = 0; k < 8; k++)
        {
            if (i == N)
                break;
            temp[k] = A[i][j];
            j++;
            if (j == M)
                j = 0, i++;
        }
        for (k--; k >= 0; k--)
        {
            j--;
            if (j == -1)
                j = M - 1, i--;
            B[j][i] = temp[k];
        }
        j += 8;
        if (j >= M)
        {
            i++;
            j %= M;
        }
        if (i == N)
            return;
    }
}
```

```shell
func 0 (Transpose submission): hits:3871, misses:4310, evictions:4278
```

å¥½åƒè¿˜æ˜¯å¾—åˆ†å—ï¼Œ8Ã—8åˆ†å—ï¼š

```cpp
void transpose_submit(int M, int N, int A[N][M], int B[M][N])
{
    int i, j, k, l;
    for (i = 0; i < N; i += 8)
    {
        for (j = 0; j < M; j += 8)
        {
            for (k = i; k < (i + 8 >= N ? N : i + 8); k++)     // å­çŸ©é˜µçš„8è¡Œ
                for (l = j; l < (j + 8 >= M ? M : j + 8); l++) // å­çŸ©é˜µçš„8åˆ—
                    B[l][k] = A[k][l];
        }
    }
}
```
æµ‹è¯•ç»“æœï¼š
```shell
func 0 (Transpose submission): hits:6060, misses:2119, evictions:2087
```

4Ã—4åˆ†å—ç»“æœï¼š
```shell
func 0 (Transpose submission): hits:5753, misses:2426, evictions:2394
```

12Ã—12åˆ†å—ç»“æœï¼š
```shell
func 0 (Transpose submission): hits:6121, misses:2058, evictions:2026
```

16Ã—16åˆ†å—ç»“æœï¼š
```shell
func 0 (Transpose submission): hits:6186, misses:1993, evictions:1961
```

20Ã—20åˆ†å—ç»“æœï¼š
```shell
func 0 (Transpose submission): hits:6176, misses:2003, evictions:1971
```

24Ã—24åˆ†å—ç»“æœï¼š
```shell
func 0 (Transpose submission): hits:6163, misses:2016, evictions:1984
```

é‚£å°±16Ã—16å§
```cpp
char transpose_submit_desc[] = "Transpose submission";
void transpose_submit(int M, int N, int A[N][M], int B[M][N])
{
    int i, j, k, l;
    int temp = 16;
    for (i = 0; i < N; i += temp)
    {
        for (j = 0; j < M; j += temp)
        {
            for (k = i; k < (i + temp >= N ? N : i + temp); k++)     // å­çŸ©é˜µçš„8è¡Œ
                for (l = j; l < (j + temp >= M ? M : j + temp); l++) // å­çŸ©é˜µçš„8åˆ—
                    B[l][k] = A[k][l];
        }
    }
}
```

```shell
root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# ./test-trans -M 61 -N 67

Function 0 (2 total)
Step 1: Validating and generating memory traces
Step 2: Evaluating performance (s=5, E=1, b=5)
func 0 (Transpose submission): hits:6186, misses:1993, evictions:1961

Function 1 (2 total)
Step 1: Validating and generating memory traces
Step 2: Evaluating performance (s=5, E=1, b=5)
func 1 (Simple row-wise scan transpose): hits:3755, misses:4424, evictions:4392

Summary for official submission (func 0): correctness=1 misses=1993

TEST_TRANS_RESULTS=1:1993
```

å…¨éƒ¨æµ‹è¯•ç»“æœï¼š
```shell
root@TABLET-ME3SC21V:/home/wajorrr/CSAPP/labs/cachelab# ./driver.py
Part A: Testing cache simulator
Running ./test-csim
                        Your simulator     Reference simulator
Points (s,E,b)    Hits  Misses  Evicts    Hits  Misses  Evicts
     3 (1,1,1)       9       8       6       9       8       6  traces/yi2.trace
     3 (4,2,4)       4       5       2       4       5       2  traces/yi.trace
     3 (2,1,4)       2       3       1       2       3       1  traces/dave.trace
     3 (2,1,3)     167      71      67     167      71      67  traces/trans.trace
     3 (2,2,3)     201      37      29     201      37      29  traces/trans.trace
     3 (2,4,3)     212      26      10     212      26      10  traces/trans.trace
     3 (5,1,5)     231       7       0     231       7       0  traces/trans.trace
     6 (5,1,5)  265189   21775   21743  265189   21775   21743  traces/long.trace
    27


Part B: Testing transpose function
Running ./test-trans -M 32 -N 32
Running ./test-trans -M 64 -N 64
Running ./test-trans -M 61 -N 67

Cache Lab summary:
                        Points   Max pts      Misses
Csim correctness          27.0        27
Trans perf 32x32           8.0         8         262
Trans perf 64x64           8.0         8        1030
Trans perf 61x67          10.0        10        1995
          Total points    53.0        53
```

ç»ˆäºæŠŠè¿™ä¸ªlabæå®šäº†